<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/project/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/project/fontawesome/css/brands.css" rel="stylesheet">
<link href="/project/fontawesome/css/solid.css" rel="stylesheet">
<script src="/project/js/color.global.min.js" ></script>
<script src="/project/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  <title>lenovo 510S-08IKL固件安全分析记录 | Edvison&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="研究联想固件时遇到的一系列问题，虽然以失败告终，但也累积了不少经验。">
<meta property="og:type" content="article">
<meta property="og:title" content="lenovo 510S-08IKL固件安全分析记录">
<meta property="og:url" content="https://edvison.github.io/project/2023/08/09/lenovo-510S-08IKL%E5%9B%BA%E4%BB%B6%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="Edvison&#39;s blog">
<meta property="og:description" content="研究联想固件时遇到的一系列问题，虽然以失败告终，但也累积了不少经验。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/05/16/dy9KEY7prROtHXM.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/17/x1A67lnXPcrgopF.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/17/GB9eRxZkiVTvdpQ.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/17/MXtNunzIkLQxWwb.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/18/vbEh2rQVa8OYcsP.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/18/NJHTSYdPC3rhi2b.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/18/KdrZbsQzctY4HyW.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/18/LNkKsEonMfb47GT.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/19/OTepNjXW5i9AoY3.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/19/wEI5WNAnHJuFyPO.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/19/oBjZAxDnCYbkmu4.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/24/83a9eUj1nOHyY7d.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/26/6UBlb7Wtsa5QKr8.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/24/jUdcYwum1fsMeGk.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/26/ZhyLEAsmO6RgU8e.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/27/G48zi6EuAMgaSDQ.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/27/el2qKHSgQaGmiOz.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/27/XjbnGN2yB7s4Fa3.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/27/ofLlkYEZgjyROAF.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/27/IgPadVnFXlefTxR.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/31/pHxXrmou4Cg6bMA.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/31/tD8f24GA5kMSsoL.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/01/PmsM9L5yrdGZUgz.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/01/j4WVRZpQNqAu6dk.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/01/SqUCj8Mtz3vuwik.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/01/5cZFIrHgyC8bwRX.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/01/C5RapLgWfwOU6tK.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/01/tLORMYqsbJADN7S.png">
<meta property="article:published_time" content="2023-08-09T07:33:15.000Z">
<meta property="article:modified_time" content="2023-08-09T07:36:50.600Z">
<meta property="article:author" content="edvison">
<meta property="article:tag" content="UEFI">
<meta property="article:tag" content="写保护突破">
<meta property="article:tag" content="SMM漏洞分析">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/05/16/dy9KEY7prROtHXM.png">
  
    <link rel="alternate" href="/project/atom.xml" title="Edvison's blog" type="application/atom+xml">
  
  
    <link rel="icon" media="(prefers-color-scheme: light)" href="/project/images/favicon-light-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/project/images/favicon-light-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/project/images/favicon-light-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/project/images/favicon-light-192.png" sizes="192x192">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/project/images/favicon-dark-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/project/images/favicon-dark-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/project/images/favicon-dark-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/project/images/favicon-dark-192.png" sizes="192x192">
  
  
<link rel="stylesheet" href="/project/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/20230807175151.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/project/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>Edvison's blog </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/project/">Home</a>
    
      <a class="main-nav-link" href="/project/archives">Archives</a>
    
      <a class="main-nav-link" href="/project/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="material-symbols-rounded light-mode-icon">wb_sunny</span>
      <span class="material-symbols-rounded dark-mode-icon">dark_mode</span>
    </a>
    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/project/atom.xml" title="RSS 订阅">
        <span class="material-symbols-rounded rss">rss_feed</span>
      </a>
    
    <a id="nav-search-btn" class="nav-icon" title="搜索" style="display: none;">
      <span class="material-symbols-rounded">search</span>
    </a>
    <div id="nav-menu-btn" class="nav-icon">
      <span class="material-symbols-rounded">menu</span>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/project/">Home</a>
    
      <a class="nav-dropdown-link" href="/project/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/project/about">About</a>
    
    
      <a class="nav-dropdown-link" href="/project/atom.xml" title="RSS 订阅">RSS</a>
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/20230808155156.png></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Edvison </div>
      <div class="dot"></div>
      <div class="subtitle">flung out of space </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/Edvison" title="github"><i class="fa-brands fa-github"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://weibo.com/u/6038772011" title="weibo"><i class="fa-brands fa-weibo"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">分类</h3>
      <div class="category-box">
            <a class="category-link" href="/project/categories/UEFI%E5%8E%9F%E7%90%86/">
                UEFI原理
                <div class="category-count">3</div>
            </a>
        
            <a class="category-link" href="/project/categories/UEFI%E5%9B%BA%E4%BB%B6%E5%AE%89%E5%85%A8/">
                UEFI固件安全
                <div class="category-count">6</div>
            </a>
        
            <a class="category-link" href="/project/categories/MBR%E5%8E%9F%E7%90%86/">
                MBR原理
                <div class="category-count">2</div>
            </a>
        
            <a class="category-link" href="/project/categories/%E7%BF%BB%E8%AF%91/">
                翻译
                <div class="category-count">4</div>
            </a>
        
            <a class="category-link" href="/project/categories/Grub2%E5%8E%9F%E7%90%86/">
                Grub2原理
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/project/categories/IoT%E5%AE%89%E5%85%A8/">
                IoT安全
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/project/categories/%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8/">
                硬件安全
                <div class="category-count">4</div>
            </a>
        
            <a class="category-link" href="/project/categories/VBIOS%E4%BF%AE%E6%94%B9/">
                VBIOS修改
                <div class="category-count">1</div>
            </a>
        </div>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">标签</h3>
      <ul class="widget-tag-list" itemprop="keywords"><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/CSM/" rel="tag">CSM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/DMA%E6%94%BB%E5%87%BB/" rel="tag">DMA攻击</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/Grub2/" rel="tag">Grub2</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/HID%E6%94%BB%E5%87%BB/" rel="tag">HID攻击</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/MBR/" rel="tag">MBR</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/MBR%E5%90%8E%E9%97%A8/" rel="tag">MBR后门</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/OS-Loader/" rel="tag">OS Loader</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/OVMF%E7%BC%96%E8%AF%91/" rel="tag">OVMF编译</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/PCH/" rel="tag">PCH</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/SMM/" rel="tag">SMM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/SMM%E5%90%8E%E9%97%A8/" rel="tag">SMM后门</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/SMM%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">SMM漏洞分析</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/UEFI/" rel="tag">UEFI</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/VBIOS/" rel="tag">VBIOS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/pcie/" rel="tag">pcie</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E5%86%99%E4%BF%9D%E6%8A%A4/" rel="tag">写保护</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E5%86%99%E4%BF%9D%E6%8A%A4%E7%AA%81%E7%A0%B4/" rel="tag">写保护突破</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E5%8E%9F%E7%90%86/" rel="tag">原理</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/" rel="tag">安全启动</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E5%BC%80%E5%8F%91%E6%9D%BF/" rel="tag">开发板</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" rel="tag">树莓派</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" rel="tag">漏洞利用</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F/" rel="tag">漏洞扫描</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">环境搭建</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E7%94%B5%E6%BA%90%E6%95%85%E9%9A%9C/" rel="tag">电源故障</a></li></ul>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">归档</h3>
      
      
        <a class="archive-link" href="/project/archives/2023/08 ">
          八月 2023 
          <div class="archive-count">22 </div>
        </a>
      
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">最新文章</h3>
      <ul>
        
          <a class="recent-link" href="/project/2023/08/09/Lenovo%E5%9B%BA%E4%BB%B6%E4%B8%AD%E7%9A%84SMM-callout%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" title="Lenovo固件中的SMM callout漏洞利用" >
            <div class="recent-link-text">
              Lenovo固件中的SMM callout漏洞利用
            </div>
          </a>
        
          <a class="recent-link" href="/project/2023/08/09/%E5%88%A9%E7%94%A8DMA%E6%94%BB%E5%87%BB%E7%AA%81%E7%A0%B4UEFI%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6/" title="利用DMA攻击突破UEFI安全机制" >
            <div class="recent-link-text">
              利用DMA攻击突破UEFI安全机制
            </div>
          </a>
        
          <a class="recent-link" href="/project/2023/08/09/UEFI-%E5%BC%95%E5%AF%BC%E8%84%9A%E6%9C%AC%E8%A1%A8%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" title="UEFI 引导脚本表漏洞利用" >
            <div class="recent-link-text">
              UEFI 引导脚本表漏洞利用
            </div>
          </a>
        
          <a class="recent-link" href="/project/2023/08/09/%E5%9F%BA%E4%BA%8EUEFI%E5%B9%B3%E5%8F%B0%E7%9A%84SMM%E5%90%8E%E9%97%A8%E6%9E%84%E5%BB%BA/" title="基于UEFI平台的SMM后门构建" >
            <div class="recent-link-text">
              基于UEFI平台的SMM后门构建
            </div>
          </a>
        
          <a class="recent-link" href="/project/2023/08/09/P4wnP1%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8/" title="P4wnP1配置与使用" >
            <div class="recent-link-text">
              P4wnP1配置与使用
            </div>
          </a>
        
      </ul>
    </div>
  </div>

    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-lenovo-510S-08IKL固件安全分析记录" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        lenovo 510S-08IKL固件安全分析记录
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2023-08-09T07:33:15.000Z" itemprop="datePublished">2023-08-09</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/project/categories/UEFI%E5%9B%BA%E4%BB%B6%E5%AE%89%E5%85%A8/">UEFI固件安全</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            3.1k 词 
          </div>
        </div>
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/project/tags/SMM%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">SMM漏洞分析</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/project/tags/UEFI/" rel="tag">UEFI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/project/tags/%E5%86%99%E4%BF%9D%E6%8A%A4%E7%AA%81%E7%A0%B4/" rel="tag">写保护突破</a></li></ul>

      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <p>研究联想固件时遇到的一系列问题，虽然以失败告终，但也累积了不少经验。</p>
<span id="more"></span>



<h2 id="NVRAM"><a href="#NVRAM" class="headerlink" title="NVRAM"></a>NVRAM</h2><ul>
<li><p>RTC lock: 0x8BD</p>
</li>
<li><p>BIOS Lock: 0x8BE</p>
</li>
<li><p>Debug Interface lock: 0x5B4</p>
</li>
<li><p>Protection Range Registers (FPRR): 0xEBA （disabled 0x0）</p>
</li>
<li><p>Intel Bios Guard Support: 0x1037</p>
</li>
<li><p>Allow Flashing BIOS to a Previous Version: 0xF35 （yes 0x1 no 0x0）</p>
</li>
<li><p>Secure Erase mode：0x4a6</p>
</li>
<li><p>Force Secure Erase: 0x4a7</p>
</li>
<li><p>One Of: Flash Support, VarStoreInfo (VarOffset&#x2F;VarName): 0x12D, VarStore: 0x1, QuestionId: 0xA31, Size: 1, Min: 0x0, Max 0x3, Step: 0x0 {05 91 EA 0D E9 0D 31 0A 01 00 2D 01 10 10 00 03 00}<br>One Of Option: Driver default, Value (8 bit): 0x0 (default) {09 07 EE 0D 10 00 00}<br>One Of Option: Disabled, Value (8 bit): 0x2 {09 07 04 00 00 00 02}<br>One Of Option: Enabled, Value (8 bit): 0x3 {09 07 03 00 00 00 03}</p>
</li>
<li><p>One Of: Flash Support, VarStoreInfo (VarOffset&#x2F;VarName): 0x197, VarStore: 0x1, QuestionId: 0xA58, Size: 1, Min: 0x0, Max 0x3, Step: 0x0 {05 91 EB 0D E9 0D 58 0A 01 00 97 01 10 10 00 03 00}<br>One Of Option: Driver default, Value (8 bit): 0x0 (default) {09 07 EE 0D 10 00 00}<br>One Of Option: Disabled, Value (8 bit): 0x2 {09 07 04 00 00 00 02}<br>One Of Option: Enabled, Value (8 bit): 0x3 {09 07 03 00 00 00 03}</p>
</li>
<li><p>One Of: Flash Support, VarStoreInfo (VarOffset&#x2F;VarName): 0x201, VarStore: 0x1, QuestionId: 0xA7F, Size: 1, Min: 0x0, Max 0x3, Step: 0x0 {05 91 EC 0D E9 0D 7F 0A 01 00 01 02 10 10 00 03 00}<br>One Of Option: Driver default, Value (8 bit): 0x0 (default) {09 07 EE 0D 10 00 00}<br>One Of Option: Disabled, Value (8 bit): 0x2 {09 07 04 00 00 00 02}<br>One Of Option: Enabled, Value (8 bit): 0x3 {09 07 03 00 00 00 03}</p>
</li>
<li><h2 id="One-Of-Flash-Support-VarStoreInfo-VarOffset-VarName-0x26B-VarStore-0x1-QuestionId-0xAA6-Size-1-Min-0x0-Max-0x3-Step-0x0-05-91-ED-0D-E9-0D-A6-0A-01-00-6B-02-10-10-00-03-00-One-Of-Option-Driver-default-Value-8-bit-0x0-default-09-07-EE-0D-10-00-00-One-Of-Option-Disabled-Value-8-bit-0x2-09-07-04-00-00-00-02-One-Of-Option-Enabled-Value-8-bit-0x3-09-07-03-00-00-00-03"><a href="#One-Of-Flash-Support-VarStoreInfo-VarOffset-VarName-0x26B-VarStore-0x1-QuestionId-0xAA6-Size-1-Min-0x0-Max-0x3-Step-0x0-05-91-ED-0D-E9-0D-A6-0A-01-00-6B-02-10-10-00-03-00-One-Of-Option-Driver-default-Value-8-bit-0x0-default-09-07-EE-0D-10-00-00-One-Of-Option-Disabled-Value-8-bit-0x2-09-07-04-00-00-00-02-One-Of-Option-Enabled-Value-8-bit-0x3-09-07-03-00-00-00-03" class="headerlink" title="One Of: Flash Support, VarStoreInfo (VarOffset&#x2F;VarName): 0x26B, VarStore: 0x1, QuestionId: 0xAA6, Size: 1, Min: 0x0, Max 0x3, Step: 0x0 {05 91 ED 0D E9 0D A6 0A 01 00 6B 02 10 10 00 03 00}One Of Option: Driver default, Value (8 bit): 0x0 (default) {09 07 EE 0D 10 00 00}One Of Option: Disabled, Value (8 bit): 0x2 {09 07 04 00 00 00 02}One Of Option: Enabled, Value (8 bit): 0x3 {09 07 03 00 00 00 03}"></a>One Of: Flash Support, VarStoreInfo (VarOffset&#x2F;VarName): 0x26B, VarStore: 0x1, QuestionId: 0xAA6, Size: 1, Min: 0x0, Max 0x3, Step: 0x0 {05 91 ED 0D E9 0D A6 0A 01 00 6B 02 10 10 00 03 00}<br>One Of Option: Driver default, Value (8 bit): 0x0 (default) {09 07 EE 0D 10 00 00}<br>One Of Option: Disabled, Value (8 bit): 0x2 {09 07 04 00 00 00 02}<br>One Of Option: Enabled, Value (8 bit): 0x3 {09 07 03 00 00 00 03}</h2></li>
<li><p>SPD Write Disable: 0xeb8 (true: 0x1, false: 0x0)</p>
</li>
<li><p>Me FW Image Re-Flash： 0x6a0（enabled: 0x1）</p>
</li>
</ul>
<h2 id="刷写"><a href="#刷写" class="headerlink" title="刷写"></a>刷写</h2><p>AFUWIN需加&#x2F;capsule选项刷写，之后会进bios页面更新，但用修改后的固件则过不了ID检测</p>
<ul>
<li>改写入程序，BIOS ID检测绕过</li>
</ul>
<p><img src="https://s2.loli.net/2022/05/16/dy9KEY7prROtHXM.png" alt="image-20220516141041217"></p>
<h2 id="chipsec检查保护位"><a href="#chipsec检查保护位" class="headerlink" title="chipsec检查保护位"></a>chipsec检查保护位</h2><p>FLOCKDN位开启</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ chipsec_main -m common.spi_lock</span><br><span class="line">[x][ =======================================================================</span><br><span class="line">[x][ Module: SPI Flash Controller Configuration Locks</span><br><span class="line">[x][ =======================================================================</span><br><span class="line">[*] HSFS = 0x3F00E800 &lt;&lt; Hardware Sequencing Flash Status Register (SPIBAR + 0x4)</span><br><span class="line">    [00] FDONE            = 0 &lt;&lt; Flash Cycle Done</span><br><span class="line">    [01] FCERR            = 0 &lt;&lt; Flash Cycle Error</span><br><span class="line">    [02] AEL              = 0 &lt;&lt; Access Error Log</span><br><span class="line">    [05] SCIP             = 0 &lt;&lt; SPI cycle in progress</span><br><span class="line">    [11] WRSDIS           = 1 &lt;&lt; Write status disable</span><br><span class="line">    [12] PR34LKD          = 0 &lt;&lt; PRR3 PRR4 Lock-Down</span><br><span class="line">    [13] FDOPSS           = 1 &lt;&lt; Flash Descriptor Override Pin-Strap Status</span><br><span class="line">    [14] FDV              = 1 &lt;&lt; Flash Descriptor Valid</span><br><span class="line">    [15] FLOCKDN          = 1 &lt;&lt; Flash Configuration Lock-Down</span><br><span class="line">    [16] FGO              = 0 &lt;&lt; Flash cycle go</span><br><span class="line">    [17] FCYCLE           = 0 &lt;&lt; Flash Cycle Type</span><br><span class="line">    [21] WET              = 0 &lt;&lt; Write Enable Type</span><br><span class="line">    [24] FDBC             = 3F &lt;&lt; Flash Data Byte Count</span><br><span class="line">    [31] FSMIE            = 0 &lt;&lt; Flash SPI SMI# Enable</span><br><span class="line">[+] SPI write status disable set.</span><br><span class="line">[+] SPI Flash Controller configuration is locked</span><br><span class="line">[+] PASSED: SPI Flash Controller locked correctly.</span><br></pre></td></tr></table></figure>

<p>BLE、SMM_BWP位开启，PR0、PR1寄存器开启</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ chipsec_main -m common.bios_wp</span><br><span class="line">[x][ =======================================================================</span><br><span class="line">[x][ Module: BIOS Region Write Protection</span><br><span class="line">[x][ =======================================================================</span><br><span class="line">[*] BC = 0x00000AAA &lt;&lt; BIOS Control (b:d.f 00:31.5 + 0xDC)</span><br><span class="line">    [00] BIOSWE           = 0 &lt;&lt; BIOS Write Enable</span><br><span class="line">    [01] BLE              = 1 &lt;&lt; BIOS Lock Enable</span><br><span class="line">    [02] SRC              = 2 &lt;&lt; SPI Read Configuration</span><br><span class="line">    [04] TSS              = 0 &lt;&lt; Top Swap Status</span><br><span class="line">    [05] SMM_BWP          = 1 &lt;&lt; SMM BIOS Write Protection</span><br><span class="line">    [06] BBS              = 0 &lt;&lt; Boot BIOS Strap</span><br><span class="line">    [07] BILD             = 1 &lt;&lt; BIOS Interface Lock Down</span><br><span class="line">[+] BIOS region write protection is enabled (writes restricted to SMM)</span><br><span class="line"> </span><br><span class="line">[*] BIOS Region: Base = 0x00200000, Limit = 0x007FFFFF</span><br><span class="line">SPI Protected Ranges</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">PRx (offset) | Value    | Base     | Limit    | WP? | RP?</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">PR0 (84)     | 87DE0740 | 00740000 | 007DEFFF | 1   | 0</span><br><span class="line">PR1 (88)     | 87FF07FC | 007FC000 | 007FFFFF | 1   | 0</span><br><span class="line">PR2 (8C)     | 00000000 | 00000000 | 00000000 | 0   | 0</span><br><span class="line">PR3 (90)     | 00000000 | 00000000 | 00000000 | 0   | 0</span><br><span class="line">PR4 (94)     | 00000000 | 00000000 | 00000000 | 0   | 0</span><br><span class="line"> </span><br><span class="line">[!] SPI protected ranges write-protect parts of BIOS region (other parts of BIOS can be modified)</span><br><span class="line"> </span><br><span class="line">[+] PASSED: BIOS is write protected</span><br></pre></td></tr></table></figure>

<p>检查s3启动表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 chipsec_main.py -m common.uefi.s3bootscript</span><br><span class="line">[*] running module: chipsec.modules.common.uefi.s3bootscript</span><br><span class="line">[x][ =======================================================================</span><br><span class="line">[x][ Module: S3 Resume Boot-Script Protections</span><br><span class="line">[x][ =======================================================================</span><br><span class="line">[*] SMRAM: Base = 0x00000000CD000000, Limit = 0x00000000CD7FFFFF, Size = 0x00800000</span><br><span class="line">[+] Didn&#x27;t find any S3 boot-scripts in EFI variables</span><br><span class="line">[!] WARNING: S3 Boot-Script was not found. Firmware may be using other ways to store/locate it, or OS might be blocking access.</span><br></pre></td></tr></table></figure>

<p>找不到s3启动表的EFI变量，用s3漏洞来绕过的方法不可行。</p>
<p>检查<code>TSEGME</code>寄存器，已锁定：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\admin\Desktop\chipsec-master&gt;python chipsec_main.py -m smm_dma</span><br><span class="line">################################################################</span><br><span class="line">##                                                            ##</span><br><span class="line">##  CHIPSEC: Platform Hardware Security Assessment Framework  ##</span><br><span class="line">##                                                            ##</span><br><span class="line">################################################################</span><br><span class="line">[CHIPSEC] Version 1.4.8</span><br><span class="line">[CHIPSEC] Arguments: -m smm_dma</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">WARNING: *******************************************************************</span><br><span class="line">WARNING: Chipsec should only be used on test systems!</span><br><span class="line">WARNING: It should not be installed/deployed on production end-user systems.</span><br><span class="line">WARNING: See WARNING.txt</span><br><span class="line">WARNING: *******************************************************************</span><br><span class="line"> </span><br><span class="line">[CHIPSEC] API mode: using CHIPSEC kernel module API</span><br><span class="line">[CHIPSEC] OS      : Windows 10 10.0.19041 AMD64</span><br><span class="line">[CHIPSEC] Python  : 2.7.14 (64-bit)</span><br><span class="line">[CHIPSEC] Helper  : Win32Helper (\??\C:\Users\admin\Desktop\chipsec-master\chipsec\helper\win\win7_amd64\chipsec_hlpr.sys)</span><br><span class="line">[CHIPSEC] Platform: Desktop 7th Generation Core Processor (Kabylake S)</span><br><span class="line">[CHIPSEC]      VID: 8086</span><br><span class="line">[CHIPSEC]      DID: 591F</span><br><span class="line">[CHIPSEC]      RID: 05</span><br><span class="line">[CHIPSEC] PCH     : Intel B250 (200 series) PCH</span><br><span class="line">[CHIPSEC]      VID: 8086</span><br><span class="line">[CHIPSEC]      DID: A2C8</span><br><span class="line">[CHIPSEC]      RID: 00</span><br><span class="line"> </span><br><span class="line">[+] loaded chipsec.modules.smm_dma</span><br><span class="line">[*] running loaded modules ..</span><br><span class="line"> </span><br><span class="line">[*] running module: chipsec.modules.smm_dma</span><br><span class="line">[x][ =======================================================================</span><br><span class="line">[x][ Module: SMM TSEG Range Configuration Check</span><br><span class="line">[x][ =======================================================================</span><br><span class="line">[*] TSEG      : 0x00000000CD000000 - 0x00000000CD7FFFFF (size = 0x00800000)</span><br><span class="line">[*] SMRR range: 0x00000000CD000000 - 0x00000000CD7FFFFF (size = 0x00800000)</span><br><span class="line"> </span><br><span class="line">[*] checking TSEG range configuration..</span><br><span class="line">[+] TSEG range covers entire SMRAM</span><br><span class="line">[+] TSEG range is locked</span><br><span class="line">[+] PASSED: TSEG is properly configured. SMRAM is protected from DMA attacks</span><br></pre></td></tr></table></figure>

<p>检查SMRR寄存器，用于保护SMRAM Cache缓存攻击的寄存器已锁定：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\admin\Desktop\chipsec-master&gt;python chipsec_main.py -m common.smrr</span><br><span class="line">################################################################</span><br><span class="line">##                                                            ##</span><br><span class="line">##  CHIPSEC: Platform Hardware Security Assessment Framework  ##</span><br><span class="line">##                                                            ##</span><br><span class="line">################################################################</span><br><span class="line">[CHIPSEC] Version 1.4.8</span><br><span class="line">[CHIPSEC] Arguments: -m common.smrr</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">WARNING: *******************************************************************</span><br><span class="line">WARNING: Chipsec should only be used on test systems!</span><br><span class="line">WARNING: It should not be installed/deployed on production end-user systems.</span><br><span class="line">WARNING: See WARNING.txt</span><br><span class="line">WARNING: *******************************************************************</span><br><span class="line"> </span><br><span class="line">[CHIPSEC] API mode: using CHIPSEC kernel module API</span><br><span class="line">[CHIPSEC] OS      : Windows 10 10.0.19041 AMD64</span><br><span class="line">[CHIPSEC] Python  : 2.7.14 (64-bit)</span><br><span class="line">[CHIPSEC] Helper  : Win32Helper (\??\C:\Users\admin\Desktop\chipsec-master\chipsec\helper\win\win7_amd64\chipsec_hlpr.sys)</span><br><span class="line">[CHIPSEC] Platform: Desktop 7th Generation Core Processor (Kabylake S)</span><br><span class="line">[CHIPSEC]      VID: 8086</span><br><span class="line">[CHIPSEC]      DID: 591F</span><br><span class="line">[CHIPSEC]      RID: 05</span><br><span class="line">[CHIPSEC] PCH     : Intel B250 (200 series) PCH</span><br><span class="line">[CHIPSEC]      VID: 8086</span><br><span class="line">[CHIPSEC]      DID: A2C8</span><br><span class="line">[CHIPSEC]      RID: 00</span><br><span class="line"> </span><br><span class="line">[+] loaded chipsec.modules.common.smrr</span><br><span class="line">[*] running loaded modules ..</span><br><span class="line"> </span><br><span class="line">[*] running module: chipsec.modules.common.smrr</span><br><span class="line">[x][ =======================================================================</span><br><span class="line">[x][ Module: CPU SMM Cache Poisoning / System Management Range Registers</span><br><span class="line">[x][ =======================================================================</span><br><span class="line">[+] OK. SMRR range protection is supported</span><br><span class="line"> </span><br><span class="line">[*] Checking SMRR range base programming..</span><br><span class="line">[*] IA32_SMRR_PHYSBASE = 0xCD000006 &lt;&lt; SMRR Base Address MSR (MSR 0x1F2)</span><br><span class="line">    [00] Type             = 6 &lt;&lt; SMRR memory type</span><br><span class="line">    [12] PhysBase         = CD000 &lt;&lt; SMRR physical base address</span><br><span class="line">[*] SMRR range base: 0x00000000CD000000</span><br><span class="line">[*] SMRR range memory type is Writeback (WB)</span><br><span class="line">[+] OK so far. SMRR range base is programmed</span><br><span class="line"> </span><br><span class="line">[*] Checking SMRR range mask programming..</span><br><span class="line">[*] IA32_SMRR_PHYSMASK = 0xFF800800 &lt;&lt; SMRR Range Mask MSR (MSR 0x1F3)</span><br><span class="line">    [11] Valid            = 1 &lt;&lt; SMRR valid</span><br><span class="line">    [12] PhysMask         = FF800 &lt;&lt; SMRR address range mask</span><br><span class="line">[*] SMRR range mask: 0x00000000FF800000</span><br><span class="line">[+] OK so far. SMRR range is enabled</span><br><span class="line"> </span><br><span class="line">[*] Verifying that SMRR range base &amp; mask are the same on all logical CPUs..</span><br><span class="line">[CPU0] SMRR_PHYSBASE = 00000000CD000006, SMRR_PHYSMASK = 00000000FF800800</span><br><span class="line">[CPU1] SMRR_PHYSBASE = 00000000CD000006, SMRR_PHYSMASK = 00000000FF800800</span><br><span class="line">[CPU2] SMRR_PHYSBASE = 00000000CD000006, SMRR_PHYSMASK = 00000000FF800800</span><br><span class="line">[CPU3] SMRR_PHYSBASE = 00000000CD000006, SMRR_PHYSMASK = 00000000FF800800</span><br><span class="line">[+] OK so far. SMRR range base/mask match on all logical CPUs</span><br><span class="line">[*] Trying to read memory at SMRR base 0xCD000000..</span><br><span class="line">[+] PASSED: SMRR reads are blocked in non-SMM mode</span><br><span class="line"> </span><br><span class="line">[+] PASSED: SMRR protection against cache attack is properly configured</span><br></pre></td></tr></table></figure>

<p>SMM_Code_Chk_En控制位检查，该功能已开启，无法执行SMRAM区域外的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\admin\Desktop\chipsec-1.8.5&gt;python chipsec_main.py -m common.smm_code_chk</span><br><span class="line">################################################################</span><br><span class="line">##                                                            ##</span><br><span class="line">##  CHIPSEC: Platform Hardware Security Assessment Framework  ##</span><br><span class="line">##                                                            ##</span><br><span class="line">################################################################</span><br><span class="line">[CHIPSEC] Version 1.8.5</span><br><span class="line">[CHIPSEC] Arguments: -m common.smm_code_chk</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">WARNING: *******************************************************************</span><br><span class="line">WARNING: Chipsec should only be used on test systems!</span><br><span class="line">WARNING: It should not be installed/deployed on production end-user systems.</span><br><span class="line">WARNING: See WARNING.txt</span><br><span class="line">WARNING: *******************************************************************</span><br><span class="line"> </span><br><span class="line">[CHIPSEC] API mode: using CHIPSEC kernel module API</span><br><span class="line">[CHIPSEC] OS      : Windows 10 10.0.19044 AMD64</span><br><span class="line">[CHIPSEC] Python  : 3.9.6 (64-bit)</span><br><span class="line">[CHIPSEC] Helper  : Win32Helper (\??\C:\Users\admin\Desktop\chipsec-1.8.5\chipsec\helper\win\win7_amd64\chipsec_hlpr.sys)</span><br><span class="line">[CHIPSEC] Platform: Desktop 7th Generation Core Processor (Kabylake S)</span><br><span class="line">[CHIPSEC]      VID: 8086</span><br><span class="line">[CHIPSEC]      DID: 591F</span><br><span class="line">[CHIPSEC]      RID: 05</span><br><span class="line">[CHIPSEC] PCH     : Intel B250 (200 series) PCH</span><br><span class="line">[CHIPSEC]      VID: 8086</span><br><span class="line">[CHIPSEC]      DID: A2C8</span><br><span class="line">[CHIPSEC]      RID: 00</span><br><span class="line"> </span><br><span class="line">[+] loaded chipsec.modules.common.smm_code_chk</span><br><span class="line">[*] running loaded modules ..</span><br><span class="line"> </span><br><span class="line">[*] running module: chipsec.modules.common.smm_code_chk</span><br><span class="line">[x][ =======================================================================</span><br><span class="line">[x][ Module: SMM_Code_Chk_En (SMM Call-Out) Protection</span><br><span class="line">[x][ =======================================================================</span><br><span class="line">[*] MSR_SMM_FEATURE_CONTROL = 0x00000005 &lt;&lt; Enhanced SMM Feature Control (MSR 0x4E0 Thread 0x0)</span><br><span class="line">    [00] LOCK             = 1 &lt;&lt; Lock bit</span><br><span class="line">    [02] SMM_Code_Chk_En  = 1 &lt;&lt; Prevents SMM from executing code outside the ranges defined by the SMRR</span><br><span class="line">[*] MSR_SMM_FEATURE_CONTROL = 0x00000005 &lt;&lt; Enhanced SMM Feature Control (MSR 0x4E0 Thread 0x1)</span><br><span class="line">    [00] LOCK             = 1 &lt;&lt; Lock bit</span><br><span class="line">    [02] SMM_Code_Chk_En  = 1 &lt;&lt; Prevents SMM from executing code outside the ranges defined by the SMRR</span><br><span class="line">[*] MSR_SMM_FEATURE_CONTROL = 0x00000005 &lt;&lt; Enhanced SMM Feature Control (MSR 0x4E0 Thread 0x2)</span><br><span class="line">    [00] LOCK             = 1 &lt;&lt; Lock bit</span><br><span class="line">    [02] SMM_Code_Chk_En  = 1 &lt;&lt; Prevents SMM from executing code outside the ranges defined by the SMRR</span><br><span class="line">[*] MSR_SMM_FEATURE_CONTROL = 0x00000005 &lt;&lt; Enhanced SMM Feature Control (MSR 0x4E0 Thread 0x3)</span><br><span class="line">    [00] LOCK             = 1 &lt;&lt; Lock bit</span><br><span class="line">    [02] SMM_Code_Chk_En  = 1 &lt;&lt; Prevents SMM from executing code outside the ranges defined by the SMRR</span><br><span class="line">[+] PASSED: SMM_Code_Chk_En is enabled and locked down</span><br></pre></td></tr></table></figure>

<h2 id="AFUWIN-v5-09-逆向破解"><a href="#AFUWIN-v5-09-逆向破解" class="headerlink" title="AFUWIN v5.09 逆向破解"></a>AFUWIN v5.09 逆向破解</h2><h3 id="解锁GAN参数"><a href="#解锁GAN参数" class="headerlink" title="解锁GAN参数"></a>解锁GAN参数</h3><p>看了下，afuwin似乎自带gan参数可以刷写所有区域，但正常版本会有个判断，无法使用gan参数：</p>
<p><img src="https://s2.loli.net/2022/05/17/x1A67lnXPcrgopF.png" alt="image-20220517171053063"></p>
<p>把比较后return 0的代码nop掉，直接进入下一步，就可以解锁gan参数了：</p>
<p><img src="https://s2.loli.net/2022/05/17/GB9eRxZkiVTvdpQ.png" alt="image-20220517171206390"></p>
<p>但是还有一层secure flash rom验证：</p>
<p><img src="https://s2.loli.net/2022/05/17/MXtNunzIkLQxWwb.png" alt="image-20220517171247776"></p>
<h3 id="Secure-flash-rom-verify绕过"><a href="#Secure-flash-rom-verify绕过" class="headerlink" title="Secure flash rom verify绕过"></a>Secure flash rom verify绕过</h3><p>在判断secure flash是否开启后，会将capsule加载到secure mem中，并进行验证：</p>
<p><img src="https://s2.loli.net/2022/05/18/vbEh2rQVa8OYcsP.png" alt="image-20220518105056244"></p>
<p>load_to_secure_mem_Verify()有几个返回值，返回非0则验证失败：</p>
<p><img src="https://s2.loli.net/2022/05/18/NJHTSYdPC3rhi2b.png" alt="image-20220518105127465"></p>
<p>把这几个返回值改为0即可绕过校验：</p>
<p><img src="https://s2.loli.net/2022/05/18/KdrZbsQzctY4HyW.png" alt="image-20220518105222914"></p>
<p>刷写成功，但还有一层启动校验，导致系统起不来了：</p>
<p><img src="https://s2.loli.net/2022/05/18/LNkKsEonMfb47GT.png" alt="image-20220518105504326"></p>
<h2 id="编程器修复"><a href="#编程器修复" class="headerlink" title="编程器修复"></a>编程器修复</h2><p>用CH341A编程器，选择W25Q64BV芯片，可读写</p>
<h2 id="capsule参数逆向"><a href="#capsule参数逆向" class="headerlink" title="capsule参数逆向"></a>capsule参数逆向</h2><p>用gan参数刷写不可行，再来看看capsule参数吧</p>
<p>capsule参数执行会mount ESP分区：</p>
<p><img src="https://s2.loli.net/2022/05/19/OTepNjXW5i9AoY3.png" alt="image-20220519093611278"></p>
<p><img src="https://s2.loli.net/2022/05/19/wEI5WNAnHJuFyPO.png" alt="image-20220519093631705"></p>
<p>并把固件复制到ESP分区下：</p>
<p><img src="https://s2.loli.net/2022/05/19/oBjZAxDnCYbkmu4.png" alt="image-20220519093744441"></p>
<p>尝试在它重启刷新前，把RECOVERY.CAP替换成我们的ROM，然后再重启。</p>
<p>但主板启动时会报警（连续4声蜂鸣）拒绝刷写替换后的ROM。</p>
<h2 id="Lenovo-510-08IKL中找到的vulnerable"><a href="#Lenovo-510-08IKL中找到的vulnerable" class="headerlink" title="Lenovo 510-08IKL中找到的vulnerable"></a>Lenovo 510-08IKL中找到的vulnerable</h2><ul>
<li><p><strong><code>NvmeSmm.efi</code></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR (low_smram_corruption.py): SMI Func: SmiHandler (0x9C0) considered vulnerable: might be abused to corrupt the lower portion of SMRAM</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="https://s2.loli.net/2022/05/24/83a9eUj1nOHyY7d.png" alt="image-20220524154638162"></p>
<p>这个是假阳性，前面有检查<code>CommBuffer-&gt;field_8</code>的大小不大于0x10个字节：</p>
<p><img src="https://s2.loli.net/2022/05/26/6UBlb7Wtsa5QKr8.png" alt="image-20220526140743898"></p>
<ul>
<li><p><strong><code>AMTLockUsbKBD.efi</code></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR (low_smram_corruption.py): SMI Func: SmiHandler (0x344) considered vulnerable: might be abused to corrupt the lower portion of SMRAM</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="https://s2.loli.net/2022/05/24/jUdcYwum1fsMeGk.png" alt="image-20220524154552014"></p>
<p>这个也是假阳性，只是传递了<code>CommBuffer</code>和<code>CommBufferSize</code>参数，没有给尝试写入通信缓冲区。</p>
<ul>
<li><p>534D0040.efi</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ERROR (setvar_infoleak.py): Function sub_F14 discloses up to 4457 SMRAM bytes while calling SetVariable() on b&#x27;Setup&#x27;</span><br><span class="line">ERROR (setvar_infoleak.py): Function sub_F14 discloses up to 4457 SMRAM bytes while calling SetVariable() on b&#x27;Setup&#x27;</span><br><span class="line">ERROR (setvar_infoleak.py): Function sub_F14 discloses up to 4457 SMRAM bytes while calling SetVariable() on b&#x27;Setup&#x27;</span><br><span class="line">ERROR (setvar_infoleak.py): Function sub_F14 discloses up to 4457 SMRAM bytes while calling SetVariable() on b&#x27;Setup&#x27;</span><br><span class="line">ERROR (setvar_infoleak.py): Function sub_F14 discloses up to 4457 SMRAM bytes while calling SetVariable() on b&#x27;Setup&#x27;</span><br><span class="line">ERROR (setvar_infoleak.py): Function sub_3878 discloses up to 32 SMRAM bytes while calling SetVariable() on b&#x27;Ep&#x27;</span><br></pre></td></tr></table></figure>


<p><img src="https://s2.loli.net/2022/05/26/ZhyLEAsmO6RgU8e.png" alt="image-20220526151103997"></p>
<p>这里固定读取Setup变量的大小为4472个字节，可作为利用点。</p>
</li>
<li><p><strong><code>WMISwSmi.efi</code></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR (efiXplorer.py): efiXplorer detected get_variable_buffer_overflow at [&#x27;0x2a54&#x27;]</span><br></pre></td></tr></table></figure>


<p><img src="https://s2.loli.net/2022/05/27/G48zi6EuAMgaSDQ.png" alt="image-20220527143655965"></p>
<p>在0x2a54的地址上找到了一个<code>GetVariable()</code>函数调用的缓冲区溢出：</p>
<p><img src="https://s2.loli.net/2022/05/27/el2qKHSgQaGmiOz.png" alt="image-20220527103409494"></p>
<p><code>GetVariable()</code>的函数定义：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span></span></span><br><span class="line"><span class="function">EFI_STATUS</span></span><br><span class="line"><span class="function"><span class="title">GetVariable</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function"> IN CHAR16 *VariableName,            <span class="comment">//A Null-terminated string that is the name of</span></span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="comment">//the vendor’s variable.</span></span></span></span><br><span class="line"><span class="params"><span class="function"> </span></span></span><br><span class="line"><span class="params"><span class="function"> IN EFI_GUID *VendorGuid,            <span class="comment">//A unique identifier for the vendor.</span></span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="comment">//Type EFI_GUID is defined in the          EFI_BOOT_SERVICES.InstallProtocolInterface() function description.</span></span></span></span><br><span class="line"><span class="params"><span class="function"> </span></span></span><br><span class="line"><span class="params"><span class="function"> OUT UINT32 *Attributes OPTIONAL,   <span class="comment">//If not NULL, a pointer to the memory location to return the                                    //attributes bitmask for the variable.</span></span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="comment">//If not NULL, then Attributes is set on output both when</span></span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="comment">//EFI_SUCCESS and when EFI_BUFFER_TOO_SMALL is returned.</span></span></span></span><br><span class="line"><span class="params"><span class="function"> </span></span></span><br><span class="line"><span class="params"><span class="function"> IN OUT UINTN *DataSize,          <span class="comment">//On input, the size in bytes of the return Data buffer.</span></span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="comment">//On output the size of data returned in Data.</span></span></span></span><br><span class="line"><span class="params"><span class="function"> </span></span></span><br><span class="line"><span class="params"><span class="function"> OUT VOID *Data OPTIONAL          <span class="comment">//The buffer to return the contents of the variable.</span></span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="comment">//May be NULL with a zero DataSize in order to determine the size buffer needed.</span></span></span></span><br><span class="line"><span class="params"><span class="function"> )</span></span>;</span><br></pre></td></tr></table></figure>


<p>返回码：</p>
<p><img src="https://s2.loli.net/2022/05/27/XjbnGN2yB7s4Fa3.png" alt="image-20220527114843179"></p>
<p><code>Data</code>缓冲区可以为0，用于确定Buffer所需的大小。如果数据缓冲区太小，无法保存变量的内容，则返回错误<code>EFI_BUFFER_TOO_SMALL</code>，并将缓冲区大小设置为所需数据的大小。</p>
<p>调用<code>GetVariable</code>获取AMITSESETUP_GUID中定义的<code>WMIAcpiMemAddr</code>变量的值，首先调用来确定Buffer所需的大小：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v10 = gRT_0-&gt;GetVariable(aWmiacpimemaddr, &amp;AMITSESETUP_GUID, 0i64, &amp;DataSize, 0i64);</span><br></pre></td></tr></table></figure>


<p>如返回值不为<code>EFI_BUFFER_TOO_SMALL</code>，或传入<code>GETVAR_Data</code>参数后返回值大于等于0则继续操作：</p>
<p><img src="https://s2.loli.net/2022/05/27/ofLlkYEZgjyROAF.png" alt="image-20220527105459149"></p>
<p><code>GETVAR_Data</code>为全局变量，且在调用前进行过初始化：</p>
<p><img src="https://s2.loli.net/2022/05/27/IgPadVnFXlefTxR.png" alt="image-20220527153756699"></p>
</li>
</ul>
<h3 id="lenovo-510-08IKL-SMIFuzz"><a href="#lenovo-510-08IKL-SMIFuzz" class="headerlink" title="lenovo 510-08IKL SMIFuzz"></a>lenovo 510-08IKL SMIFuzz</h3><p>用chipsec触发所有可能的SW SMI handlers:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">for /l %%a in (0,1,255) do (</span><br><span class="line">python chipsec_util.py smi 0 %%a 0)</span><br></pre></td></tr></table></figure>


<p>执行完54号正在执行55号的时候系统就挂起了：</p>
<p><img src="https://s2.loli.net/2022/05/31/pHxXrmou4Cg6bMA.png" alt="image-20220531101713832"></p>
<p>SMM驱动程序使用<code>EFI_SMM_SW_DISPATCH2_PROTOCOL</code>协议的<code>Register()</code>函数来注册SW SMI handlers，下面是EDK2中的定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_SMM_SW_DISPATCH2_PROTOCOL_GUID EFI_MM_SW_DISPATCH_PROTOCOL_GUID</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EFI_SMM_SW_DISPATCH2_PROTOCOL</span>  <span class="title">EFI_SMM_SW_DISPATCH2_PROTOCOL</span>;</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Register a child SMI source dispatch function for the specified software SMI.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">  This service registers a function (DispatchFunction) which will be called when the software</span></span><br><span class="line"><span class="comment">  SMI source specified by RegisterContext-&gt;SwSmiCpuIndex is detected. On return,</span></span><br><span class="line"><span class="comment">  DispatchHandle contains a unique handle which may be used later to unregister the function</span></span><br><span class="line"><span class="comment">  using UnRegister().</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">  @param[in]  This                 Pointer to the EFI_SMM_SW_DISPATCH2_PROTOCOL instance.</span></span><br><span class="line"><span class="comment">  @param[in]  DispatchFunction     Function to register for handler when the specified software</span></span><br><span class="line"><span class="comment">                                   SMI is generated.</span></span><br><span class="line"><span class="comment">  @param[in, out] RegisterContext  Pointer to the dispatch function&#x27;s context.</span></span><br><span class="line"><span class="comment">                                   The caller fills this context in before calling</span></span><br><span class="line"><span class="comment">                                   the register function to indicate to the register</span></span><br><span class="line"><span class="comment">                                   function which Software SMI input value the</span></span><br><span class="line"><span class="comment">                                   dispatch function should be invoked for.</span></span><br><span class="line"><span class="comment">  @param[out] DispatchHandle       Handle generated by the dispatcher to track the</span></span><br><span class="line"><span class="comment">                                   function instance.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">  @retval EFI_SUCCESS            The dispatch function has been successfully</span></span><br><span class="line"><span class="comment">                                 registered and the SMI source has been enabled.</span></span><br><span class="line"><span class="comment">  @retval EFI_DEVICE_ERROR       The SW driver was unable to enable the SMI source.</span></span><br><span class="line"><span class="comment">  @retval EFI_INVALID_PARAMETER  RegisterContext is invalid. The SW SMI input value</span></span><br><span class="line"><span class="comment">                                 is not within a valid range or is already in use.</span></span><br><span class="line"><span class="comment">  @retval EFI_OUT_OF_RESOURCES   There is not enough memory (system or SMM) to manage this</span></span><br><span class="line"><span class="comment">                                 child.</span></span><br><span class="line"><span class="comment">  @retval EFI_OUT_OF_RESOURCES   A unique software SMI value could not be assigned</span></span><br><span class="line"><span class="comment">                                 for this dispatch.</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">typedef</span></span><br><span class="line"><span class="title function_">EFI_STATUS</span></span><br><span class="line"><span class="params">(EFIAPI *EFI_SMM_SW_REGISTER2)</span><span class="params">(</span></span><br><span class="line"><span class="params">  IN  CONST EFI_SMM_SW_DISPATCH2_PROTOCOL  *This,</span></span><br><span class="line"><span class="params">  IN        EFI_SMM_HANDLER_ENTRY_POINT2   DispatchFunction,</span></span><br><span class="line"><span class="params">  IN  OUT   EFI_SMM_SW_REGISTER_CONTEXT    *RegisterContext,</span></span><br><span class="line"><span class="params">  OUT       EFI_HANDLE                     *DispatchHandle</span></span><br><span class="line"><span class="params">  )</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Unregister a child SMI source dispatch function for the specified software SMI.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">  This service removes the handler associated with DispatchHandle so that it will no longer be</span></span><br><span class="line"><span class="comment">  called in response to a software SMI.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">  @param[in] This                Pointer to the EFI_SMM_SW_DISPATCH2_PROTOCOL instance.</span></span><br><span class="line"><span class="comment">  @param[in] DispatchHandle      Handle of dispatch function to deregister.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">  @retval EFI_SUCCESS            The dispatch function has been successfully unregistered.</span></span><br><span class="line"><span class="comment">  @retval EFI_INVALID_PARAMETER  The DispatchHandle was not valid.</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">typedef</span></span><br><span class="line"><span class="title function_">EFI_STATUS</span></span><br><span class="line"><span class="params">(EFIAPI *EFI_SMM_SW_UNREGISTER2)</span><span class="params">(</span></span><br><span class="line"><span class="params">  IN CONST EFI_SMM_SW_DISPATCH2_PROTOCOL  *This,</span></span><br><span class="line"><span class="params">  IN       EFI_HANDLE                     DispatchHandle</span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Interface structure for the SMM Software SMI Dispatch Protocol.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The EFI_SMM_SW_DISPATCH2_PROTOCOL provides the ability to install child handlers for the</span></span><br><span class="line"><span class="comment">/// given software.  These handlers will respond to software interrupts, and the maximum software</span></span><br><span class="line"><span class="comment">/// interrupt in the EFI_SMM_SW_REGISTER_CONTEXT is denoted by MaximumSwiValue.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">EFI_SMM_SW_DISPATCH2_PROTOCOL</span> &#123;</span></span><br><span class="line">  EFI_SMM_SW_REGISTER2    Register;</span><br><span class="line">  EFI_SMM_SW_UNREGISTER2  UnRegister;</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// A read-only field that describes the maximum value that can be used in the</span></span><br><span class="line">  <span class="comment">/// EFI_SMM_SW_DISPATCH2_PROTOCOL.Register() service.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  UINTN                  MaximumSwiValue;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">extern</span> EFI_GUID gEfiSmmSwDispatch2ProtocolGuid;</span><br></pre></td></tr></table></figure>

<p><code>EFI_MM_SW_DISPATCH_PROTOCOL_GUID</code>为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_MM_SW_DISPATCH_PROTOCOL_GUID \</span></span><br><span class="line"><span class="meta">  &#123; \</span></span><br><span class="line"><span class="meta">    0x18a3c6dc, 0x5eea, 0x48c8, &#123;0xa1, 0xc1, 0xb5, 0x33, 0x89, 0xf9, 0x89, 0x99 &#125; \</span></span><br><span class="line"><span class="meta">  &#125;</span></span><br></pre></td></tr></table></figure>


<p>UEFITool中能找到一堆调用了该GUID的驱动程序：</p>
<p><img src="https://s2.loli.net/2022/05/31/tD8f24GA5kMSsoL.png" alt="image-20220531153034099"></p>
<p>只能一个个地看，找导致崩溃的55号SMI handler了</p>
<h4 id="SMM-Call-Out误报"><a href="#SMM-Call-Out误报" class="headerlink" title="SMM Call Out误报"></a>SMM Call Out误报</h4><ul>
<li><p><code>MicrocodeUpdate.efi</code></p>
<p><img src="https://s2.loli.net/2022/06/01/PmsM9L5yrdGZUgz.png" alt="image-20220601105814543"></p>
<p>这里如果它要释放的Buffer是在SMRAM则会调用<code>gSmst-&gt;SmmFreePool()</code>，否则调用<code>gBs-&gt;FreePool()</code></p>
<p>不能将其判定为CallOut</p>
</li>
<li><p><code>SmbiosDmiEdit.efi</code></p>
</li>
</ul>
<p><img src="https://s2.loli.net/2022/06/01/j4WVRZpQNqAu6dk.png" alt="image-20220601143353871"></p>
<p>调用了<code>gRT_0-&gt;Getvariable()</code>，乍一看似乎是CallOut，但实际上不是。它调用了位于SMRAM中的UEFI配置表<code>EFI_SMM_RUNTIME_SERVICES_TABLE</code>，重新映射了全局指针<code>RuntimeService</code>，其功能与<code>EFI_RUNTIME_SERVICES_TABLE</code>相同，可用于SMI handlers中：</p>
<p><img src="https://s2.loli.net/2022/06/01/SqUCj8Mtz3vuwik.png" alt="image-20220601144025263"></p>
<p><img src="https://s2.loli.net/2022/06/01/5cZFIrHgyC8bwRX.png" alt="image-20220601144037169"></p>
<p>所以这也是个误报。</p>
<ul>
<li><p><code>OemSmi.efi</code></p>
<p>同上理由，是误报：</p>
<p><img src="https://s2.loli.net/2022/06/01/C5RapLgWfwOU6tK.png" alt="image-20220601145637041"></p>
<p><img src="https://s2.loli.net/2022/06/01/tLORMYqsbJADN7S.png" alt="image-20220601145652396"></p>
</li>
</ul>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/project/2023/08/09/CSM%E5%85%BC%E5%AE%B9%E7%9A%84OVMF%E5%88%B6%E4%BD%9C/"
      title="CSM兼容的OVMF制作"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        CSM兼容的OVMF制作
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/project/2023/08/09/brick%E2%80%94%E2%80%94SMM%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F%E5%B7%A5%E5%85%B7/"
      title="brick——SMM漏洞扫描工具"
     >

    <p class="title-text">
      
        brick——SMM漏洞扫描工具
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>


  
  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <div id="comment-card" class="comment-card">
    <div class="main-title-bar">
      <div class="main-title-dot"></div>
      <div class="main-title">留言 </div>
    </div>
    <div id="vcomments"></div>
  </div>
  <script>
      new Valine({"enable":true,"appId":"bC8HOSKa4QB7G6TfuGWB97i4-gzGzoHsz","appKey":"aoDFuSX5vWN8Xn1ukZpJ50be","placeholder":"写下你的评论...","pageSize":10,"highlight":true,"serverURLs":null,"el":"#vcomments"});
  </script>
 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2023 Edvison<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn" onclick="topFunction()">
        <span class="material-symbols-rounded">keyboard_arrow_up</span>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.style.opacity = 1;
        } else {
            btn.style.opacity = 0;
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/project/js/light-dark-switch.js"></script>
</body>
</html>
