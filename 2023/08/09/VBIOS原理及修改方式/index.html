<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/project/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/project/fontawesome/css/brands.css" rel="stylesheet">
<link href="/project/fontawesome/css/solid.css" rel="stylesheet">
<script src="/project/js/color.global.min.js" ></script>
<script src="/project/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  <title>VBIOS原理及修改方式 | Edvison&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="VBIOS原理学习及修改方法。">
<meta property="og:type" content="article">
<meta property="og:title" content="VBIOS原理及修改方式">
<meta property="og:url" content="https://edvison.github.io/project/2023/08/09/VBIOS%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BF%AE%E6%94%B9%E6%96%B9%E5%BC%8F/index.html">
<meta property="og:site_name" content="Edvison&#39;s blog">
<meta property="og:description" content="VBIOS原理学习及修改方法。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230619152420302.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230619152826956.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230714161814751.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230714161841274.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230714110011039.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230714110156458.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230718152007477.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230719160740310.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230714160445057.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230714160620189.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230714160846658.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230619105557543.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230619110057275.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230619112400124.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230619112420944.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230710110936626.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230710144422381.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230710144534946.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230710113010525.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230718104404332.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230718104430826.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230718153910183.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230718154008408.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230718154307891.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230718154158764.png">
<meta property="og:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230719160055920.png">
<meta property="article:published_time" content="2023-08-09T08:02:09.000Z">
<meta property="article:modified_time" content="2023-08-09T08:05:09.676Z">
<meta property="article:author" content="edvison">
<meta property="article:tag" content="UEFI">
<meta property="article:tag" content="VBIOS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230619152420302.png">
  
    <link rel="alternate" href="/project/atom.xml" title="Edvison's blog" type="application/atom+xml">
  
  
    <link rel="icon" media="(prefers-color-scheme: light)" href="/project/images/favicon-light-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/project/images/favicon-light-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/project/images/favicon-light-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/project/images/favicon-light-192.png" sizes="192x192">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/project/images/favicon-dark-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/project/images/favicon-dark-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/project/images/favicon-dark-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/project/images/favicon-dark-192.png" sizes="192x192">
  
  
<link rel="stylesheet" href="/project/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/20230807175151.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/project/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>Edvison's blog </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/project/">Home</a>
    
      <a class="main-nav-link" href="/project/archives">Archives</a>
    
      <a class="main-nav-link" href="/project/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="material-symbols-rounded light-mode-icon">wb_sunny</span>
      <span class="material-symbols-rounded dark-mode-icon">dark_mode</span>
    </a>
    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/project/atom.xml" title="RSS 订阅">
        <span class="material-symbols-rounded rss">rss_feed</span>
      </a>
    
    <a id="nav-search-btn" class="nav-icon" title="搜索" style="display: none;">
      <span class="material-symbols-rounded">search</span>
    </a>
    <div id="nav-menu-btn" class="nav-icon">
      <span class="material-symbols-rounded">menu</span>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/project/">Home</a>
    
      <a class="nav-dropdown-link" href="/project/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/project/about">About</a>
    
    
      <a class="nav-dropdown-link" href="/project/atom.xml" title="RSS 订阅">RSS</a>
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/20230808155156.png></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Edvison </div>
      <div class="dot"></div>
      <div class="subtitle">flung out of space </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/Edvison" title="github"><i class="fa-brands fa-github"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://weibo.com/u/6038772011" title="weibo"><i class="fa-brands fa-weibo"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">分类</h3>
      <div class="category-box">
            <a class="category-link" href="/project/categories/UEFI%E5%8E%9F%E7%90%86/">
                UEFI原理
                <div class="category-count">3</div>
            </a>
        
            <a class="category-link" href="/project/categories/UEFI%E5%9B%BA%E4%BB%B6%E5%AE%89%E5%85%A8/">
                UEFI固件安全
                <div class="category-count">6</div>
            </a>
        
            <a class="category-link" href="/project/categories/MBR%E5%8E%9F%E7%90%86/">
                MBR原理
                <div class="category-count">2</div>
            </a>
        
            <a class="category-link" href="/project/categories/%E7%BF%BB%E8%AF%91/">
                翻译
                <div class="category-count">4</div>
            </a>
        
            <a class="category-link" href="/project/categories/Grub2%E5%8E%9F%E7%90%86/">
                Grub2原理
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/project/categories/IoT%E5%AE%89%E5%85%A8/">
                IoT安全
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/project/categories/%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8/">
                硬件安全
                <div class="category-count">4</div>
            </a>
        
            <a class="category-link" href="/project/categories/VBIOS%E4%BF%AE%E6%94%B9/">
                VBIOS修改
                <div class="category-count">1</div>
            </a>
        </div>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">标签</h3>
      <ul class="widget-tag-list" itemprop="keywords"><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/CSM/" rel="tag">CSM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/DMA%E6%94%BB%E5%87%BB/" rel="tag">DMA攻击</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/Grub2/" rel="tag">Grub2</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/HID%E6%94%BB%E5%87%BB/" rel="tag">HID攻击</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/MBR/" rel="tag">MBR</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/MBR%E5%90%8E%E9%97%A8/" rel="tag">MBR后门</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/OS-Loader/" rel="tag">OS Loader</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/OVMF%E7%BC%96%E8%AF%91/" rel="tag">OVMF编译</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/PCH/" rel="tag">PCH</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/SMM/" rel="tag">SMM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/SMM%E5%90%8E%E9%97%A8/" rel="tag">SMM后门</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/SMM%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">SMM漏洞分析</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/UEFI/" rel="tag">UEFI</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/VBIOS/" rel="tag">VBIOS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/pcie/" rel="tag">pcie</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E5%86%99%E4%BF%9D%E6%8A%A4/" rel="tag">写保护</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E5%86%99%E4%BF%9D%E6%8A%A4%E7%AA%81%E7%A0%B4/" rel="tag">写保护突破</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E5%8E%9F%E7%90%86/" rel="tag">原理</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/" rel="tag">安全启动</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E5%BC%80%E5%8F%91%E6%9D%BF/" rel="tag">开发板</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" rel="tag">树莓派</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" rel="tag">漏洞利用</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F/" rel="tag">漏洞扫描</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">环境搭建</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E7%94%B5%E6%BA%90%E6%95%85%E9%9A%9C/" rel="tag">电源故障</a></li></ul>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">归档</h3>
      
      
        <a class="archive-link" href="/project/archives/2023/08 ">
          八月 2023 
          <div class="archive-count">22 </div>
        </a>
      
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">最新文章</h3>
      <ul>
        
          <a class="recent-link" href="/project/2023/08/09/Lenovo%E5%9B%BA%E4%BB%B6%E4%B8%AD%E7%9A%84SMM-callout%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" title="Lenovo固件中的SMM callout漏洞利用" >
            <div class="recent-link-text">
              Lenovo固件中的SMM callout漏洞利用
            </div>
          </a>
        
          <a class="recent-link" href="/project/2023/08/09/%E5%88%A9%E7%94%A8DMA%E6%94%BB%E5%87%BB%E7%AA%81%E7%A0%B4UEFI%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6/" title="利用DMA攻击突破UEFI安全机制" >
            <div class="recent-link-text">
              利用DMA攻击突破UEFI安全机制
            </div>
          </a>
        
          <a class="recent-link" href="/project/2023/08/09/UEFI-%E5%BC%95%E5%AF%BC%E8%84%9A%E6%9C%AC%E8%A1%A8%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" title="UEFI 引导脚本表漏洞利用" >
            <div class="recent-link-text">
              UEFI 引导脚本表漏洞利用
            </div>
          </a>
        
          <a class="recent-link" href="/project/2023/08/09/%E5%9F%BA%E4%BA%8EUEFI%E5%B9%B3%E5%8F%B0%E7%9A%84SMM%E5%90%8E%E9%97%A8%E6%9E%84%E5%BB%BA/" title="基于UEFI平台的SMM后门构建" >
            <div class="recent-link-text">
              基于UEFI平台的SMM后门构建
            </div>
          </a>
        
          <a class="recent-link" href="/project/2023/08/09/P4wnP1%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8/" title="P4wnP1配置与使用" >
            <div class="recent-link-text">
              P4wnP1配置与使用
            </div>
          </a>
        
      </ul>
    </div>
  </div>

    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-VBIOS原理及修改方式" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        VBIOS原理及修改方式
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2023-08-09T08:02:09.000Z" itemprop="datePublished">2023-08-09</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/project/categories/VBIOS%E4%BF%AE%E6%94%B9/">VBIOS修改</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            1.6k 词 
          </div>
        </div>
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/project/tags/UEFI/" rel="tag">UEFI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/project/tags/VBIOS/" rel="tag">VBIOS</a></li></ul>

      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <p>VBIOS原理学习及修改方法。</p>
<span id="more"></span>

<h1 id="GOP与VBIOS原理"><a href="#GOP与VBIOS原理" class="headerlink" title="GOP与VBIOS原理"></a>GOP与VBIOS原理</h1><h2 id="GOP与VBIOS区别"><a href="#GOP与VBIOS区别" class="headerlink" title="GOP与VBIOS区别"></a>GOP与VBIOS区别</h2><p>VBIOS是由IBM PC衍生的Video BIOS，用于初始化显卡，为加载显卡驱动之前的基本视频输出提供INT 10h中断和VESA BIOS扩展。作为常见的Option ROM，在POST后由BIOS执行。</p>
<p>GOP（Graphics output protocol）——图形输出协议，GOP提供对硬件帧缓冲区的访问，提供显示的基本功能。为取代VGA BIOS，并在没有CSM的情况下使用。</p>
<p>Intel的GOP会放在BIOS中，主要包括三部分：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230619152420302.png" alt="image-20230619152420302"></p>
<ol>
<li>IntelGopDriver.efi：GOP的DXE驱动</li>
<li>IntelGraphicsPeim.efi：PEI阶段的GOP</li>
<li>VBT：GOP配置文件</li>
</ol>
<p>调用阶段如下：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230619152826956.png" alt="image-20230619152826956"></p>
<p>在OS启动过程中，OS Loader会通过 ExitBootervices()通知 Driver 退出，这时 GOP 会在从系统中卸载。但是 Intel GFX Driver会继续使用 VBT 提供的配置信息。</p>
<h2 id="显卡VBIOS结构"><a href="#显卡VBIOS结构" class="headerlink" title="显卡VBIOS结构"></a>显卡VBIOS结构</h2><p>独显中的VBIOS通常会包括VBIOS和GOP两个镜像，和UEFI BIOS中的VBIOS一样，是一个PCI Expansion PROM的结构。</p>
<h3 id="PCIR头和数据结构定义"><a href="#PCIR头和数据结构定义" class="headerlink" title="PCIR头和数据结构定义"></a>PCIR头和数据结构定义</h3><p>PCIR头通常为28个字节的数据，其定义如下：</p>
<table>
<thead>
<tr>
<th>byte offset</th>
<th>value</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>00</td>
<td>55</td>
<td>PROM signature</td>
</tr>
<tr>
<td>01</td>
<td>aa</td>
<td>PROM signature</td>
</tr>
<tr>
<td>02-03</td>
<td>33 00</td>
<td>SPARC reserved value（可扩展处理器架构保留值）</td>
</tr>
<tr>
<td>04-17</td>
<td>00 00</td>
<td>为特有的处理器架构保留的数据</td>
</tr>
<tr>
<td>18-19</td>
<td>1c 00</td>
<td>指向PCI数据结构的指针</td>
</tr>
<tr>
<td>1a-1b</td>
<td>00 00</td>
<td>填充</td>
</tr>
</tbody></table>
<p>PCIR数据结构通常为24个字节，其定义如下：</p>
<table>
<thead>
<tr>
<th>Byte Offset</th>
<th>Description&#x2F;(Hex. value)</th>
</tr>
</thead>
<tbody><tr>
<td>00-03</td>
<td>Signature : P C I R (50 43 49 52)</td>
</tr>
<tr>
<td>04-05</td>
<td>Vendor ID</td>
</tr>
<tr>
<td>06-07</td>
<td>Device ID</td>
</tr>
<tr>
<td>08-09</td>
<td>product data指针</td>
</tr>
<tr>
<td>0A-0B</td>
<td>PCI data structure 长度(18 00)</td>
</tr>
<tr>
<td>0C</td>
<td>PCI data structure 版本号</td>
</tr>
<tr>
<td>0D</td>
<td>编程接口代码</td>
</tr>
<tr>
<td>0E</td>
<td>子类代码</td>
</tr>
<tr>
<td>0F</td>
<td>类代码</td>
</tr>
<tr>
<td>10-11</td>
<td>image length in 512 bytes</td>
</tr>
<tr>
<td>12-13</td>
<td>Revision level of code&#x2F;data</td>
</tr>
<tr>
<td>14</td>
<td>Code type</td>
</tr>
<tr>
<td>15</td>
<td>标识字节，如果是最后一个镜像则值为0x80</td>
</tr>
<tr>
<td>16-17</td>
<td>保留值</td>
</tr>
</tbody></table>
<p>注意这里的标识字节，现代显卡一般会包含两个PCI ROM，分别对应VBT和GOP，如RX550的VBIOS:</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230714161814751.png" alt="image-20230714161814751"></p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230714161841274.png" alt="image-20230714161841274"></p>
<p>这个GOP的PCI ROM的标识字节就为0x80，如果要禁用GOP，那么就可以把ATOMBIOS的标识字节改为0x80。</p>
<blockquote>
<p>但是修改后要不要修改CRC校验和，还是个问题。校验块的位置似乎不包括这个头的数据。</p>
</blockquote>
<p>以上是对于通用VBIOS的PCIR头和结构定义，而AMD显卡的VBIOS——Atombios，在此基础上又有细分了几个表的定义。</p>
<p>PCIR头后跟了一段ATI magic，用于标识Atombios：</p>
<table>
<thead>
<tr>
<th align="center">Offset</th>
<th align="center">Size</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0x00</td>
<td align="center">Word</td>
<td align="center">BIOS Magic, should be 0xAA55</td>
</tr>
<tr>
<td align="center">0x02</td>
<td align="center">byte</td>
<td align="center">Image SIZE &#x3D; value * 512</td>
</tr>
<tr>
<td align="center">0x30</td>
<td align="center">10 bytes</td>
<td align="center">ATI Magic, should be “ 761295520”</td>
</tr>
<tr>
<td align="center">0x48</td>
<td align="center">Word</td>
<td align="center">Atom ROM Table Base</td>
</tr>
</tbody></table>
<p>如RX550的VBIOS：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230714110011039.png" alt="image-20230714110011039"></p>
<p>0x48字节处的值（0x234）指向了ATOM ROM表的偏移：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230714110156458.png" alt="image-20230714110156458"></p>
<p>0x02字节处标识ATOMBIOS IMAGE的大小，如：</p>
<p>0x73 * 512 &#x3D; 0xE600</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230718152007477.png" alt="image-20230718152007477"></p>
<p>同时PCIR头的0x10-0x11偏移处也标识了IMAGE的大小，计算方法同上：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230719160740310.png" alt="image-20230719160740310"></p>
<h4 id="ATOM-ROM-table"><a href="#ATOM-ROM-table" class="headerlink" title="ATOM ROM table"></a>ATOM ROM table</h4><p>ATOM ROM表定义如下：</p>
<table>
<thead>
<tr>
<th align="center">Offset</th>
<th align="center">Size</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0x00</td>
<td align="center">4 bytes</td>
<td align="center">Common header</td>
</tr>
<tr>
<td align="center">0x04</td>
<td align="center">4 bytes</td>
<td align="center">Atom Magic, should be “ATOM”</td>
</tr>
<tr>
<td align="center">0x08</td>
<td align="center">Word</td>
<td align="center">BIOS运行时的段地址</td>
</tr>
<tr>
<td align="center">0x0A</td>
<td align="center">Word</td>
<td align="center">Protected Mode Info Offset</td>
</tr>
<tr>
<td align="center">0x0C</td>
<td align="center">Word</td>
<td align="center">Config Filename Offset</td>
</tr>
<tr>
<td align="center">0x0E</td>
<td align="center">Word</td>
<td align="center">CRC Block Offset</td>
</tr>
<tr>
<td align="center">0x10</td>
<td align="center">Word</td>
<td align="center">Name String offset（可为0，最大512bytes）</td>
</tr>
<tr>
<td align="center">0x12</td>
<td align="center">Word</td>
<td align="center">Int 10 offset</td>
</tr>
<tr>
<td align="center">0x14</td>
<td align="center">Word</td>
<td align="center">PCI总线设备初始化代码</td>
</tr>
<tr>
<td align="center">0x16</td>
<td align="center">Word</td>
<td align="center">IO基址</td>
</tr>
<tr>
<td align="center">0x18</td>
<td align="center">Word</td>
<td align="center">Subsystem Vendor ID</td>
</tr>
<tr>
<td align="center">0x1A</td>
<td align="center">Word</td>
<td align="center">Subsystem ID</td>
</tr>
<tr>
<td align="center">0x1C</td>
<td align="center">Word</td>
<td align="center">PCI Info Offset</td>
</tr>
<tr>
<td align="center">0x1E</td>
<td align="center">Word</td>
<td align="center">Command Table Base</td>
</tr>
<tr>
<td align="center">0x20</td>
<td align="center">Word</td>
<td align="center">Data Table Base</td>
</tr>
<tr>
<td align="center">0x22</td>
<td align="center">Byte</td>
<td align="center">Extended Function Code</td>
</tr>
<tr>
<td align="center">0x23</td>
<td align="center">Byte</td>
<td align="center">Reserved</td>
</tr>
</tbody></table>
<p>根据该表定义可以看出下面还定义了好几个表的偏移地址。<strong>需要注意的是，这个偏移是针对整个镜像文件开始的位置，而不是ATOM ROM表开始的位置</strong></p>
<p>大多数表使用的头定义如下：</p>
<h4 id="Common-header"><a href="#Common-header" class="headerlink" title="Common header"></a>Common header</h4><table>
<thead>
<tr>
<th align="center">Offset</th>
<th align="center">Size</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0x00</td>
<td align="center">Word</td>
<td align="center">表定义结构的长度</td>
</tr>
<tr>
<td align="center">0x02</td>
<td align="center">Byte</td>
<td align="center">表格式修订，当解析器不向后兼容时更改</td>
</tr>
<tr>
<td align="center">0x03</td>
<td align="center">Byte</td>
<td align="center">表内容修订</td>
</tr>
</tbody></table>
<h4 id="command-table"><a href="#command-table" class="headerlink" title="command table"></a>command table</h4><table>
<thead>
<tr>
<th align="center">Offset</th>
<th align="center">Size</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0x00</td>
<td align="center">4 bytes</td>
<td align="center">Common Header</td>
</tr>
<tr>
<td align="center">0x04</td>
<td align="center">x words</td>
<td align="center">Array offsets of commands</td>
</tr>
</tbody></table>
<h4 id="command-format"><a href="#command-format" class="headerlink" title="command format"></a>command format</h4><p>命令格式定义：</p>
<table>
<thead>
<tr>
<th align="center">Offset</th>
<th align="center">Size</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0x00</td>
<td align="center">Word</td>
<td align="center">Command Length</td>
</tr>
<tr>
<td align="center">0x02</td>
<td align="center">Word</td>
<td align="center">Reserved</td>
</tr>
<tr>
<td align="center">0x04</td>
<td align="center">Byte</td>
<td align="center">WS?</td>
</tr>
<tr>
<td align="center">0x05</td>
<td align="center">Byte</td>
<td align="center">PS - Parameter Stack</td>
</tr>
<tr>
<td align="center">0x06-0x????</td>
<td align="center">??</td>
<td align="center">Command bytecode</td>
</tr>
</tbody></table>
<p>RX550的command table偏移：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230714160445057.png" alt="image-20230714160445057"></p>
<p>该表定义了结构的大小为A6个字节，以及各个命令数组的偏移：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230714160620189.png" alt="image-20230714160620189"></p>
<h4 id="Data-table"><a href="#Data-table" class="headerlink" title="Data table"></a>Data table</h4><table>
<thead>
<tr>
<th align="center">Offset</th>
<th align="center">Size</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0x00</td>
<td align="center">4 bytes</td>
<td align="center">Common Header</td>
</tr>
<tr>
<td align="center">0x04</td>
<td align="center">Word</td>
<td align="center">UtilityPipeline</td>
</tr>
<tr>
<td align="center">0x06</td>
<td align="center">Word</td>
<td align="center">MultimediaCapabilityInfo</td>
</tr>
<tr>
<td align="center">0x08</td>
<td align="center">Word</td>
<td align="center">MultimediaConfigInfo</td>
</tr>
<tr>
<td align="center">0x0A</td>
<td align="center">Word</td>
<td align="center">StandardVesa_Timing</td>
</tr>
<tr>
<td align="center">0x0C</td>
<td align="center">Word</td>
<td align="center">FirmwareInfo</td>
</tr>
<tr>
<td align="center">0x0E</td>
<td align="center">Word</td>
<td align="center">PaletteData</td>
</tr>
<tr>
<td align="center">0x10</td>
<td align="center">Word</td>
<td align="center">LCD_Info</td>
</tr>
<tr>
<td align="center">0x12</td>
<td align="center">Word</td>
<td align="center">DIGTransmitterInfo</td>
</tr>
<tr>
<td align="center">0x14</td>
<td align="center">Word</td>
<td align="center">AnalogTV_Info</td>
</tr>
<tr>
<td align="center">0x16</td>
<td align="center">Word</td>
<td align="center">SupportedDevicesInfo</td>
</tr>
<tr>
<td align="center">0x18</td>
<td align="center">Word</td>
<td align="center">GPIO_I2C_Info</td>
</tr>
<tr>
<td align="center">0x1A</td>
<td align="center">Word</td>
<td align="center">VRAM_UsageByFirmware</td>
</tr>
<tr>
<td align="center">0x1C</td>
<td align="center">Word</td>
<td align="center">GPIO_Pin_LUT</td>
</tr>
<tr>
<td align="center">0x1E</td>
<td align="center">Word</td>
<td align="center">VESA_ToInternalModeLUT</td>
</tr>
<tr>
<td align="center">0x20</td>
<td align="center">Word</td>
<td align="center">ComponentVideoInfo</td>
</tr>
<tr>
<td align="center">0x22</td>
<td align="center">Word</td>
<td align="center">PowerPlayInfo</td>
</tr>
<tr>
<td align="center">0x24</td>
<td align="center">Word</td>
<td align="center">CompassionateData</td>
</tr>
<tr>
<td align="center">0x26</td>
<td align="center">Word</td>
<td align="center">SaveRestoreInfo</td>
</tr>
<tr>
<td align="center">0x28</td>
<td align="center">Word</td>
<td align="center">PPLL_SS_Info</td>
</tr>
<tr>
<td align="center">0x2A</td>
<td align="center">Word</td>
<td align="center">OemInfo</td>
</tr>
<tr>
<td align="center">0x2C</td>
<td align="center">Word</td>
<td align="center">XTMDS_Info</td>
</tr>
<tr>
<td align="center">0x2E</td>
<td align="center">Word</td>
<td align="center">MclkSS_Info</td>
</tr>
<tr>
<td align="center">0x30</td>
<td align="center">Word</td>
<td align="center">Object_header</td>
</tr>
<tr>
<td align="center">0x32</td>
<td align="center">Word</td>
<td align="center">IndirectIOAccess</td>
</tr>
<tr>
<td align="center">0x34</td>
<td align="center">Word</td>
<td align="center">MC_InitParameter</td>
</tr>
<tr>
<td align="center">0x36</td>
<td align="center">Word</td>
<td align="center">ASIC_VDDC_Info</td>
</tr>
<tr>
<td align="center">0x38</td>
<td align="center">Word</td>
<td align="center">ASIC_InternalSS_Info</td>
</tr>
<tr>
<td align="center">0x3A</td>
<td align="center">Word</td>
<td align="center">TV_VideoMode</td>
</tr>
<tr>
<td align="center">0x3C</td>
<td align="center">Word</td>
<td align="center">VRAM_Info</td>
</tr>
<tr>
<td align="center">0x3E</td>
<td align="center">Word</td>
<td align="center">MemoryTrainingInfo</td>
</tr>
<tr>
<td align="center">0x40</td>
<td align="center">Word</td>
<td align="center">IntegratedSystemInfo</td>
</tr>
<tr>
<td align="center">0x42</td>
<td align="center">Word</td>
<td align="center">ASIC_ProfilingInfo</td>
</tr>
<tr>
<td align="center">0x44</td>
<td align="center">Word</td>
<td align="center">VoltageObjectInfo</td>
</tr>
<tr>
<td align="center">0x46</td>
<td align="center">Word</td>
<td align="center">PowerSourceInfo</td>
</tr>
</tbody></table>
<p>command表后紧接着就是data表，包含了各类信息表的偏移：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230714160846658.png" alt="image-20230714160846658"></p>
<h2 id="INT-10H中断"><a href="#INT-10H中断" class="headerlink" title="INT 10H中断"></a>INT 10H中断</h2><p>该中断处理程序用于提供视频显示服务，包括设置视频模式、字符和字符串输出以及在图形模式下的读取和写入像素。</p>
<h1 id="VBIOS提取"><a href="#VBIOS提取" class="headerlink" title="VBIOS提取"></a>VBIOS提取</h1><p>用mmtool可提取VBIOS&#x2F;VBT:</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230619105557543.png" alt="image-20230619105557543"></p>
<p>实际上就是CSMCORE RAW里的部分内容。</p>
<p>hex查看提取的内容:</p>
<p>version OROM VBIOS：HASWELL 2173</p>
<p>version VBT：AA 00 -&gt; AA（v1.70）</p>
<p>size VBT: ff 10 -&gt; 10ff （4351 byte）</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230619110057275.png" alt="image-20230619110057275"></p>
<p>使用Intel BMP工具可编辑VBIOS镜像，需要选择对应版本的BSF脚本：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230619112400124.png" alt="image-20230619112400124"></p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230619112420944.png" alt="image-20230619112420944"></p>
<h2 id="显卡VBIOS读写"><a href="#显卡VBIOS读写" class="headerlink" title="显卡VBIOS读写"></a>显卡VBIOS读写</h2><p>GPU-Z可查看显卡信息，并读取VBIOS:</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230710110936626.png"></p>
<p>A卡使用amdvbflash工具，-i参数读取适配器id：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230710144422381.png"></p>
<p>写入VBIOS：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">amdvbflash.exe -p -f [id] &lt;*.rom&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230710144534946.png"></p>
<p>A卡使用GopInfoX.exe可查看GOP信息：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230710113010525.png"></p>
<h1 id="VBIOS修改"><a href="#VBIOS修改" class="headerlink" title="VBIOS修改"></a>VBIOS修改</h1><p>修改CRC对刷写工具的解析有影响，未修改的固件无法识别ID，而修改后的可以：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230718104404332.png" alt="image-20230718104404332"></p>
<p>修改方式为把ATOMBIOS尾部的FF修改为7F，平衡CRC校验和（0xFF-0x80&#x3D;0x7F）：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230718104430826.png" alt="image-20230718104430826"></p>
<p>把GOP镜像全填充为FF，并在最后0x1000个字节处填充csminsert数据。但这样就无法修改单个数据来平衡校验和了。</p>
<p>修改校验和，用PolarisBIOSEditor打开，会提示未修改校验和，点确定，再SAVE AS另存为文件后即可修复校验和：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230718153910183.png" alt="image-20230718153910183"></p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230718154008408.png" alt="image-20230718154008408"></p>
<p>另外一提，这个校验和的位置为0x21的偏移处：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230718154307891.png" alt="image-20230718154307891"></p>
<p>用amdvbflash写入时可以正常识别ID了：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230718154158764.png" alt="image-20230718154158764"></p>
<p>不出所料，这样暴力修改后刷进去显卡就变砖了。</p>
<h2 id="恢复方法"><a href="#恢复方法" class="headerlink" title="恢复方法"></a>恢复方法</h2><p>找个能设置集显优先输出的主板，在插入了RX 550的情况下，从集显进入系统，使用amdvbflash -i可以识别到适配器id，刷回原版固件即可。</p>
<p>如MSI B360M MORTAR的设置：</p>
<p><img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/image-20230719160055920.png" alt="image-20230719160055920"></p>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/project/2023/08/09/P4wnP1%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8/"
      title="P4wnP1配置与使用"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        P4wnP1配置与使用
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/project/2023/08/09/OS-Loader%E5%88%B0%E5%86%85%E6%A0%B8%E7%9A%84%E6%8E%A7%E5%88%B6%E6%9D%83%E8%BD%AC%E7%A7%BB/"
      title="OS Loader到内核的控制权转移"
     >

    <p class="title-text">
      
        OS Loader到内核的控制权转移
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>


  
  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <div id="comment-card" class="comment-card">
    <div class="main-title-bar">
      <div class="main-title-dot"></div>
      <div class="main-title">留言 </div>
    </div>
    <div id="vcomments"></div>
  </div>
  <script>
      new Valine({"enable":true,"appId":"bC8HOSKa4QB7G6TfuGWB97i4-gzGzoHsz","appKey":"aoDFuSX5vWN8Xn1ukZpJ50be","placeholder":"写下你的评论...","pageSize":10,"highlight":true,"serverURLs":null,"el":"#vcomments"});
  </script>
 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2023 Edvison<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn" onclick="topFunction()">
        <span class="material-symbols-rounded">keyboard_arrow_up</span>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.style.opacity = 1;
        } else {
            btn.style.opacity = 0;
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/project/js/light-dark-switch.js"></script>
</body>
</html>
