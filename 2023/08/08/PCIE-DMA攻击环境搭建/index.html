<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/project/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/project/fontawesome/css/brands.css" rel="stylesheet">
<link href="/project/fontawesome/css/solid.css" rel="stylesheet">
<script src="/project/js/color.global.min.js" ></script>
<script src="/project/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  <title>PCIE DMA攻击环境搭建 | Edvison&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="基于 Xilinx ZC706 开发板的DMA攻击工具环境搭建过程。 实现与主机PCIe总线的TLP数据包收发、解析、物理内存读取等功能。">
<meta property="og:type" content="article">
<meta property="og:title" content="PCIE DMA攻击环境搭建">
<meta property="og:url" content="https://edvison.github.io/project/2023/08/08/PCIE-DMA%E6%94%BB%E5%87%BB%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/index.html">
<meta property="og:site_name" content="Edvison&#39;s blog">
<meta property="og:description" content="基于 Xilinx ZC706 开发板的DMA攻击工具环境搭建过程。 实现与主机PCIe总线的TLP数据包收发、解析、物理内存读取等功能。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/07/14/p4GkLOAF6dERBfn.png">
<meta property="og:image" content="https://i.loli.net/2021/07/14/r67vCPMimRpOWsf.png">
<meta property="og:image" content="https://i.loli.net/2021/07/14/dUi4atRC2TyVgqc.png">
<meta property="og:image" content="https://i.loli.net/2021/07/27/1PafSzxuy7RJVjH.png">
<meta property="og:image" content="https://i.loli.net/2021/07/29/4M9f5LdEDWVtvjP.png">
<meta property="og:image" content="https://i.loli.net/2021/07/27/tkuS1o6QnLesf9m.png">
<meta property="og:image" content="https://i.loli.net/2021/07/27/n3dKQTbLs6ijxuO.png">
<meta property="og:image" content="https://i.loli.net/2021/07/27/9jhQwSrKTIdn1AX.png">
<meta property="og:image" content="https://i.loli.net/2021/07/27/LjChPQNvkRldapK.png">
<meta property="article:published_time" content="2023-08-08T09:15:13.000Z">
<meta property="article:modified_time" content="2023-08-08T10:00:12.817Z">
<meta property="article:author" content="edvison">
<meta property="article:tag" content="pcie">
<meta property="article:tag" content="DMA攻击">
<meta property="article:tag" content="环境搭建">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/07/14/p4GkLOAF6dERBfn.png">
  
    <link rel="alternate" href="/project/atom.xml" title="Edvison's blog" type="application/atom+xml">
  
  
    <link rel="icon" media="(prefers-color-scheme: light)" href="/project/images/favicon-light-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/project/images/favicon-light-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/project/images/favicon-light-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/project/images/favicon-light-192.png" sizes="192x192">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/project/images/favicon-dark-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/project/images/favicon-dark-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/project/images/favicon-dark-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/project/images/favicon-dark-192.png" sizes="192x192">
  
  
<link rel="stylesheet" href="/project/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/20230807175151.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/project/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>Edvison's blog </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/project/">Home</a>
    
      <a class="main-nav-link" href="/project/archives">Archives</a>
    
      <a class="main-nav-link" href="/project/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="material-symbols-rounded light-mode-icon">wb_sunny</span>
      <span class="material-symbols-rounded dark-mode-icon">dark_mode</span>
    </a>
    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/project/atom.xml" title="RSS 订阅">
        <span class="material-symbols-rounded rss">rss_feed</span>
      </a>
    
    <a id="nav-search-btn" class="nav-icon" title="搜索" style="display: none;">
      <span class="material-symbols-rounded">search</span>
    </a>
    <div id="nav-menu-btn" class="nav-icon">
      <span class="material-symbols-rounded">menu</span>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/project/">Home</a>
    
      <a class="nav-dropdown-link" href="/project/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/project/about">About</a>
    
    
      <a class="nav-dropdown-link" href="/project/atom.xml" title="RSS 订阅">RSS</a>
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=https://myimage-1254411429.cos.ap-chengdu.myqcloud.com/20230808155156.png></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Edvison </div>
      <div class="dot"></div>
      <div class="subtitle">flung out of space </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/Edvison" title="github"><i class="fa-brands fa-github"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://weibo.com/u/6038772011" title="weibo"><i class="fa-brands fa-weibo"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">分类</h3>
      <div class="category-box">
            <a class="category-link" href="/project/categories/UEFI%E5%8E%9F%E7%90%86/">
                UEFI原理
                <div class="category-count">3</div>
            </a>
        
            <a class="category-link" href="/project/categories/UEFI%E5%9B%BA%E4%BB%B6%E5%AE%89%E5%85%A8/">
                UEFI固件安全
                <div class="category-count">6</div>
            </a>
        
            <a class="category-link" href="/project/categories/MBR%E5%8E%9F%E7%90%86/">
                MBR原理
                <div class="category-count">2</div>
            </a>
        
            <a class="category-link" href="/project/categories/%E7%BF%BB%E8%AF%91/">
                翻译
                <div class="category-count">4</div>
            </a>
        
            <a class="category-link" href="/project/categories/Grub2%E5%8E%9F%E7%90%86/">
                Grub2原理
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/project/categories/IoT%E5%AE%89%E5%85%A8/">
                IoT安全
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/project/categories/%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8/">
                硬件安全
                <div class="category-count">4</div>
            </a>
        
            <a class="category-link" href="/project/categories/VBIOS%E4%BF%AE%E6%94%B9/">
                VBIOS修改
                <div class="category-count">1</div>
            </a>
        </div>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">标签</h3>
      <ul class="widget-tag-list" itemprop="keywords"><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/CSM/" rel="tag">CSM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/DMA%E6%94%BB%E5%87%BB/" rel="tag">DMA攻击</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/Grub2/" rel="tag">Grub2</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/HID%E6%94%BB%E5%87%BB/" rel="tag">HID攻击</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/MBR/" rel="tag">MBR</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/MBR%E5%90%8E%E9%97%A8/" rel="tag">MBR后门</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/OS-Loader/" rel="tag">OS Loader</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/OVMF%E7%BC%96%E8%AF%91/" rel="tag">OVMF编译</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/PCH/" rel="tag">PCH</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/SMM/" rel="tag">SMM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/SMM%E5%90%8E%E9%97%A8/" rel="tag">SMM后门</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/SMM%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">SMM漏洞分析</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/UEFI/" rel="tag">UEFI</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/VBIOS/" rel="tag">VBIOS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/pcie/" rel="tag">pcie</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E5%86%99%E4%BF%9D%E6%8A%A4/" rel="tag">写保护</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E5%86%99%E4%BF%9D%E6%8A%A4%E7%AA%81%E7%A0%B4/" rel="tag">写保护突破</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E5%8E%9F%E7%90%86/" rel="tag">原理</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/" rel="tag">安全启动</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E5%BC%80%E5%8F%91%E6%9D%BF/" rel="tag">开发板</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" rel="tag">树莓派</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" rel="tag">漏洞利用</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F/" rel="tag">漏洞扫描</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">环境搭建</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/project/tags/%E7%94%B5%E6%BA%90%E6%95%85%E9%9A%9C/" rel="tag">电源故障</a></li></ul>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">归档</h3>
      
      
        <a class="archive-link" href="/project/archives/2023/08 ">
          八月 2023 
          <div class="archive-count">22 </div>
        </a>
      
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">最新文章</h3>
      <ul>
        
          <a class="recent-link" href="/project/2023/08/09/Lenovo%E5%9B%BA%E4%BB%B6%E4%B8%AD%E7%9A%84SMM-callout%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" title="Lenovo固件中的SMM callout漏洞利用" >
            <div class="recent-link-text">
              Lenovo固件中的SMM callout漏洞利用
            </div>
          </a>
        
          <a class="recent-link" href="/project/2023/08/09/%E5%88%A9%E7%94%A8DMA%E6%94%BB%E5%87%BB%E7%AA%81%E7%A0%B4UEFI%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6/" title="利用DMA攻击突破UEFI安全机制" >
            <div class="recent-link-text">
              利用DMA攻击突破UEFI安全机制
            </div>
          </a>
        
          <a class="recent-link" href="/project/2023/08/09/UEFI-%E5%BC%95%E5%AF%BC%E8%84%9A%E6%9C%AC%E8%A1%A8%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" title="UEFI 引导脚本表漏洞利用" >
            <div class="recent-link-text">
              UEFI 引导脚本表漏洞利用
            </div>
          </a>
        
          <a class="recent-link" href="/project/2023/08/09/%E5%9F%BA%E4%BA%8EUEFI%E5%B9%B3%E5%8F%B0%E7%9A%84SMM%E5%90%8E%E9%97%A8%E6%9E%84%E5%BB%BA/" title="基于UEFI平台的SMM后门构建" >
            <div class="recent-link-text">
              基于UEFI平台的SMM后门构建
            </div>
          </a>
        
          <a class="recent-link" href="/project/2023/08/09/P4wnP1%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8/" title="P4wnP1配置与使用" >
            <div class="recent-link-text">
              P4wnP1配置与使用
            </div>
          </a>
        
      </ul>
    </div>
  </div>

    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-PCIE-DMA攻击环境搭建" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        PCIE DMA攻击环境搭建
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2023-08-08T09:15:13.000Z" itemprop="datePublished">2023-08-08</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/project/categories/%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8/">硬件安全</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            2.4k 词 
          </div>
        </div>
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/project/tags/DMA%E6%94%BB%E5%87%BB/" rel="tag">DMA攻击</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/project/tags/pcie/" rel="tag">pcie</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/project/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">环境搭建</a></li></ul>

      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <p>基于 <a target="_blank" rel="noopener" href="https://www.xilinx.com/products/boards-and-kits/ek-z7-zc706-g.html">Xilinx ZC706</a> 开发板的DMA攻击工具环境搭建过程。</p>
<p>实现与主机PCIe总线的TLP数据包收发、解析、物理内存读取等功能。</p>
<span id="more"></span>

<p><a target="_blank" rel="noopener" href="https://github.com/Cr4sh/zc_pcie_dma">项目地址</a></p>
<h1 id="Vivado安装"><a href="#Vivado安装" class="headerlink" title="Vivado安装"></a>Vivado安装</h1><p>在ubuntu下安装<a target="_blank" rel="noopener" href="https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/vivado-design-tools/archive.html">Vivado 2019.2</a>。</p>
<p><img src="https://i.loli.net/2021/07/14/p4GkLOAF6dERBfn.png" alt="image-20210714145336758"></p>
<p>解压安装包文件，运行<code>sudo ./xsetup</code>进行安装。</p>
<p><strong>选择Vivado HL. Design Edition版本，安装目录选择默认的，最好不要更改。</strong></p>
<p>在Vivado License Manager中选load License导入证书文件：  [LICENSE FOR ISE VIVADO.lic](D:\software\Xilinx\LICENSE FOR ISE VIVADO.lic)</p>
<h1 id="安装Petalinux"><a href="#安装Petalinux" class="headerlink" title="安装Petalinux"></a>安装Petalinux</h1><p>安装依赖库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install tofrodos gawk xvfb git libncurses5-dev tftpd zlib1g-dev zlib1g-dev:i386 libssl-dev flex bison chrpath socat autoconf libtool texinfo gcc-multilib libsdl1.2-dev libglib2.0-dev screen pax xterm diffstat build-essential</span><br></pre></td></tr></table></figure>

<p>下载<a target="_blank" rel="noopener" href="https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/embedded-design-tools/archive.html">Petalinux</a>。</p>
<p>配置安装目录及权限：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -s</span><br><span class="line">$ mkdir -p /opt/pkg/petalinux</span><br><span class="line">$ chown edvison /opt/pkg/</span><br><span class="line">$ chgrp edvison /opt/pkg/</span><br><span class="line">$ chgrp edvison /opt/pkg/petalinux/</span><br><span class="line">$ chown edvison /opt/pkg/petalinux/</span><br><span class="line">$ exit</span><br></pre></td></tr></table></figure>

<p>安装petalinux：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chmod +x petalinux-v2019.2-final-installer.run</span><br><span class="line">$ ./petalinux-v2019.2-final-installer.run /opt/pkg/petalinux/</span><br></pre></td></tr></table></figure>

<p>设置环境变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ export PATH=$PATH:/opt/pkg/petalinux/tools/xsct/bin/</span><br></pre></td></tr></table></figure>

<h1 id="Xilinx-Zynq-DMA攻击项目准备"><a href="#Xilinx-Zynq-DMA攻击项目准备" class="headerlink" title="Xilinx Zynq DMA攻击项目准备"></a>Xilinx Zynq DMA攻击项目准备</h1><p>获取项目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/Cr4sh/zc_pcie_dma</span><br></pre></td></tr></table></figure>

<p>进入vivado安装目录，配置环境变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd /tools/Xilinx/Vivado/2019.2</span><br><span class="line">$ source settings64.sh</span><br></pre></td></tr></table></figure>

<ol>
<li>进入zc_pcie_dma项目目录下，运行<code>make project</code>从<code>zx_pcie_dma.tcl</code>模板创建Vivado项目。</li>
</ol>
<p><img src="https://i.loli.net/2021/07/14/r67vCPMimRpOWsf.png" alt="image-20210714160103911"></p>
<ol start="2">
<li><p>运行<code>vivado</code>，<code>Open project &gt;</code>，打开<code>~/zc_pcie_dma/zc_pcie_dma/zc_pcie_dma.xpr</code>，执行<code>Run Synthesis</code>，等待右上角的后台运行完成后，执行<code>Run implementation</code>，完成后执行<code>generate the bitstream</code>。点<code>File --&gt; Export --&gt; Export Hardware..</code>导出到<code>zc_pcie_dma.xsa</code>文件中。</p>
</li>
<li><p>运行<code>make bin</code></p>
<p><img src="https://i.loli.net/2021/07/14/dUi4atRC2TyVgqc.png" alt="image-20210714170031442">运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git submodule init &amp;&amp; git submodule update</span><br><span class="line">$ cd devicetree/my_dtg/</span><br><span class="line">$ git clone https://github.com/Xilinx/device-tree-xlnx</span><br><span class="line">$ cd device-tree-xlnx</span><br><span class="line">$ git checkout xilinx-v2019.2</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载并编译DTC：</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git clone git://git.kernel.org/pub/scm/utils/dtc/dtc.git</span><br><span class="line">$ sudo apt install flex bison</span><br><span class="line">$ cd dtc</span><br><span class="line">$ make</span><br><span class="line">$ export PATH=$PATH:$(pwd)</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>运行<code>make dts_gen</code>生成设备树源码</li>
<li>打开<code>devicetree/my_dts/pl.dtsi</code>文件，把所有的<code>compatible = &quot;xlnx,axi-dma-7.1&quot;, &quot;xlnx,axi-dma-1.00.a&quot;</code>和<code>compatible = &quot;xlnx,axi-gpio-2.0&quot;, &quot;xlnx,xps-gpio-1.00.a&quot;</code>都替换成<code>compatible = &quot;generic-uio&quot;</code>。</li>
<li>运行<code>make dts_build</code>，生成设备树二进制文件。</li>
</ol>
<h1 id="Buildroot构建环境"><a href="#Buildroot构建环境" class="headerlink" title="Buildroot构建环境"></a>Buildroot构建环境</h1><p>使用 Buildroot 来交叉编译 Linux 内核和 uBoot 引导加载程序。</p>
<p>安装Buildroot:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://buildroot.org/downloads/buildroot-2021.02.tar.gz</span><br><span class="line">$ tar -xpvf buildroot-2021.02.tar.gz</span><br><span class="line">$ cd ~/buildroot-2021.02</span><br></pre></td></tr></table></figure>

<p>安装依赖:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install libncurses-dev</span><br></pre></td></tr></table></figure>

<p>使用ZC706开发板的标准配置文件初始化构建环境：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make zynq_zc706_defconfig</span><br><span class="line">$ echo “BR2_PACKAGE_ZC_DMA_MEM=y” &gt;&gt; .config</span><br></pre></td></tr></table></figure>

<p>配置linux内核：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make linux-menuconfig</span><br></pre></td></tr></table></figure>

<p>开启下面的选项：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Device Drivers--&gt;</span><br><span class="line">    GPIO Support--&gt;</span><br><span class="line">        Memory mapped GPIO drivers--&gt;</span><br><span class="line">             [*]Xilinx GPIO support</span><br><span class="line">             [*]Xilinx Zynq GPIO support</span><br><span class="line">Device Drivers--&gt;</span><br><span class="line">    Userspace I/O drivers</span><br><span class="line">kernel hacking--&gt;</span><br><span class="line">    [*] Filter access to /dev/mem</span><br><span class="line">    [*]   Filter I/O access to /dev/mem</span><br><span class="line">Enable loadable module support--&gt;</span><br><span class="line">    [*]   Forced module loading                                                        </span><br><span class="line">    [*]   Module unloading                                                                   [*]     Forced module unloading                                                           [*]   Module versioning support</span><br></pre></td></tr></table></figure>

<p>设置br2外部树<code>zc_dma_mem</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make BR2_EXTERNAL=&quot;~/zc_pcie_dma/kernel/zc_dma_mem&quot; menuconfig</span><br></pre></td></tr></table></figure>

<p>开启选项<code>External options -&gt; zc_dma_mem</code>。</p>
<p>设置hostname，root密码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">System configuration --&gt;</span><br><span class="line">    System hostname</span><br><span class="line">    System banner</span><br><span class="line">    Root password</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/07/27/1PafSzxuy7RJVjH.png" alt="image-20210727141613598"></p>
<p>编译内核、bootloder、<code>zc_dma_mem.ko</code>内核模块和文件系统：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br></pre></td></tr></table></figure>

<p>如报错<code>cannot stat &#39;package/busybox/S02sysctl&#39;: No such file or directory</code>，添加软链接：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ln -s S02sysctl ../procps-ng/S02sysctl</span><br></pre></td></tr></table></figure>

<p>生成<code>zc_dma_mem.ko</code>位于：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/buildroot-2021.02/output/build/zc_dma_mem-1.0</span><br><span class="line">~/buildroot-2021.02/output/target/lib/modules/4.9.0-xilinx/extra</span><br></pre></td></tr></table></figure>

<h1 id="更改内核版本方法"><a href="#更改内核版本方法" class="headerlink" title="更改内核版本方法"></a>更改内核版本方法</h1><p>安装buildroot 2020.02版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://buildroot.org/downloads/buildroot-2020.02.tar.gz</span><br><span class="line">$ tar -xpvf buildroot-2020.02.tar.gz</span><br><span class="line">$ cd ~/buildroot-2020.02</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://2456cc35.wiz06.com/wapp/pages/view/share/s/0AlIMR0YIkmh2tjeP42sDMEN1PBHWz2YVk3j2FLwGD3lsIYA">安装gcc5，g++5</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Xilinx/linux-xlnx/releases">https://github.com/Xilinx/linux-xlnx/releases</a> 可查找所需的内核包。</p>
<p>要把内核版本改为4.0，则需要linux-xilinx-v2015.4.tar.gz版本的包，内核版本号可在包里的Makefile中查看：</p>
<p><img src="https://i.loli.net/2021/07/29/4M9f5LdEDWVtvjP.png" alt="image-20210729105135408"></p>
<p>找到需要的内核包后，运行<code>make menuconfig</code>，更改下面的选项：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Toolchain --&gt;</span><br><span class="line">    Custom kernel headers series (4.0.x)  ---&gt;</span><br><span class="line">    GCC compiler Version (gcc 5.x)  ---&gt;</span><br><span class="line">kernel --&gt;</span><br><span class="line">    ($(call github,Xilinx,linux-xlnx,xilinx-v2015.4)/linux-xilinx-v2015.4.tar.gz) URL of custom kernel tarball</span><br></pre></td></tr></table></figure>

<p>再次运行<code>make linux-menuconfig</code>，即可下载并配置更改的内核版本。</p>
<h1 id="设置Fat32分区引导SD卡"><a href="#设置Fat32分区引导SD卡" class="headerlink" title="设置Fat32分区引导SD卡"></a>设置Fat32分区引导SD卡</h1><p>复制需要的文件到SD目录下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p output/images/sd</span><br><span class="line">$ cp output/images/boot.bin output/images/sd</span><br><span class="line">$ cp output/images/uImage output/images/sd</span><br><span class="line">$ cp output/images/u-boot.img output/images/sd/u-boot.img</span><br><span class="line">$ cp output/images/rootfs.cpio.uboot output/images/sd/uramdisk.image.gz</span><br><span class="line">$ cp ~/zc_pcie_dma/devicetree.dtb output/images/sd</span><br><span class="line">$ cp ~/zc_pcie_dma/zc_pcie_dma.bit output/images/sd</span><br></pre></td></tr></table></figure>

<p>创建uEnv.txt文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ gedit uEnv.txt</span><br><span class="line">bootargs=console=ttyPS0,115200 root=/dev/mmcblk0p2 rw earlyprintk rootfstype=fat rootwait devtmpfs.mount=0 mem=992M uio_pdrv_genirq.of_id=generic-uio</span><br><span class="line">load_fpga=fatload mmc 0 0x4000000 zc_pcie_dma.bit &amp;&amp; fpga loadb 0 0x4000000 13321511</span><br><span class="line">load_image=fatload mmc 0 $&#123;kernel_load_address&#125; $&#123;kernel_image&#125; &amp;&amp; fatload mmc 0 $&#123;devicetree_load_address&#125; devicetree.dtb</span><br><span class="line">uenvcmd=echo Copying Linux from SD to RAM... &amp;&amp; mmcinfo &amp;&amp; run load_fpga &amp;&amp; run load_image &amp;&amp; bootm $&#123;kernel_load_address&#125; - $&#123;devicetree_load_address&#125;</span><br></pre></td></tr></table></figure>

<p>格式化SD卡，类型为FAT：</p>
<p><img src="https://i.loli.net/2021/07/27/tkuS1o6QnLesf9m.png" alt="image-20210727142435335"></p>
<p>将sd目录下所有文件复制到sd卡：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd ~/buildroot-2021.02/output/images/sd</span><br><span class="line">$ sudo cp -a * /media/edvison/boot</span><br></pre></td></tr></table></figure>

<p>弹出SD卡：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo eject /dev/sdc</span><br></pre></td></tr></table></figure>

<p>sd卡插回zc706，连接USB串口调试线，SW11设置为00110（SD卡引导模式）：</p>
<p><img src="https://i.loli.net/2021/07/27/n3dKQTbLs6ijxuO.png" alt="image-20210727151447201"></p>
<p>主机开始监听：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pip install pyserial</span><br><span class="line">$ sudo miniterm.py --eol LF --raw /dev/ttyUSB0 115200</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/07/27/9jhQwSrKTIdn1AX.png" alt="image-20210727143032050"></p>
<p>———————————————-分界线———————————————————–</p>
<h1 id="设置ext4分区引导SD卡"><a href="#设置ext4分区引导SD卡" class="headerlink" title="设置ext4分区引导SD卡"></a>设置ext4分区引导SD卡</h1><p><strong>下面是构建ubuntu文件系统方法</strong></p>
<p>安装qemu用户空间模拟：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install qemu-user-static</span><br><span class="line">$ sudo apt install qemu-user-binfmt</span><br></pre></td></tr></table></figure>

<p>检查ARM用户空间模拟配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/sys/fs/binfmt_misc/qemu-arm</span><br><span class="line">enabled</span><br><span class="line">interpreter /usr/bin/qemu-arm-static</span><br><span class="line">flags: OC</span><br><span class="line">offset 0</span><br><span class="line">magic 7f454c4601010100000000000000000002002800</span><br><span class="line">mask ffffffffffffff00fffffffffffffffffeffffff</span><br></pre></td></tr></table></figure>

<p>依赖包安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install gawk wget git git-core diffstat unzip texinfo gcc-multilib build-essential \</span><br><span class="line">chrpath socat cpio python python3 python3-pip python3-pexpect \</span><br><span class="line">xz-utils debianutils iputils-ping libsdl1.2-dev xterm \</span><br><span class="line">language-pack-en coreutils texi2html file docbook-utils \</span><br><span class="line">python-pysqlite2 help2man desktop-file-utils \</span><br><span class="line">libgl1-mesa-dev libglu1-mesa-dev mercurial autoconf automake \</span><br><span class="line">groff curl lzop asciidoc u-boot-tools libreoffice-writer \</span><br><span class="line">sshpass ssh-askpass zip xz-utils kpartx vim screen bison flex \</span><br><span class="line">debootstrap qemu-system-arm qemu-user-static libssl-dev</span><br></pre></td></tr></table></figure>

<p>交叉编译器安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install gcc-arm-linux-gnueabi</span><br></pre></td></tr></table></figure>

<p>使用debootstrap获取ubuntu 20.04文件系统：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install debootstrap</span><br><span class="line">$ sudo debootstrap --arch armhf --verbose --foreign focal ~/debootstrap_focal_armhf</span><br></pre></td></tr></table></figure>

<p>准备chroot环境：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cp /usr/bin/qemu-arm-static debootstrap_focal_armhf/usr/bin</span><br><span class="line">$ sudo chroot debootstrap_focal_armhf /bin/bash</span><br></pre></td></tr></table></figure>

<p>运行第二阶段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ /debootstrap/debootstrap --second-stage</span><br></pre></td></tr></table></figure>

<p>基本配置，创建<code>/etc/fstab</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot;/dev/mmcblk0p1 /boot vfat umask=0077 0 1&quot; &gt;&gt; /etc/fstab</span><br><span class="line">$ echo &quot;/dev/mmcblk0p2 /ext4 relatime,errors=remount-ro 0 1&quot; &gt;&gt; /etc/fstab</span><br></pre></td></tr></table></figure>

<p>配置主机名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/hostname</span><br><span class="line">zc706</span><br><span class="line">$ cat /etc/hosts</span><br><span class="line">127.0.0.1    localhost zc706</span><br><span class="line">::1          localhost ip6-localhost ip6-loopback</span><br><span class="line">ff02::1        ip6-allnodes</span><br><span class="line">ff02::2        ip6-allrouters</span><br></pre></td></tr></table></figure>

<p>设置root密码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ passwd</span><br></pre></td></tr></table></figure>

<p>创建非root用户添加到sudo组中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ adduser edvison</span><br><span class="line">$ adduser edvison sudo</span><br></pre></td></tr></table></figure>

<p>添加apt下载源：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/apt/sources.list</span><br><span class="line">deb http://ports.ubuntu.com/ubuntu-ports focal main</span><br></pre></td></tr></table></figure>

<p>安装vim:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install vim</span><br></pre></td></tr></table></figure>

<p>配置网络：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install network-manager network-manager-pptp network-manager-gnome network-manager-pptp-gnome</span><br><span class="line">$ sudo apt install net-tools</span><br></pre></td></tr></table></figure>

<p>报错解决：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/y345996249/article/details/105652493">Ubuntu下locale命令路径无法找到问题解决方法：Cannot set LC_CTYPE to default locale: No such file or directory</a></p>
<p>退出chroot环境：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ exit</span><br></pre></td></tr></table></figure>

<p>擦除SD卡内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ dd if=/dev/zero of=/dev/sdc bs=1024</span><br></pre></td></tr></table></figure>

<p>运行fdisk创建两个分区，256MB的引导分区和存放根文件系统的分区：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">$ sudo fdisk /dev/sdc</span><br><span class="line">欢迎使用 fdisk (util-linux 2.32)。</span><br><span class="line">更改将停留在内存中，直到您决定将更改写入磁盘。</span><br><span class="line">使用写入命令前请三思。</span><br><span class="line"> </span><br><span class="line">设备不包含可识别的分区表。</span><br><span class="line">创建了一个磁盘标识符为 0x7f900099 的新 DOS 磁盘标签。</span><br><span class="line"> </span><br><span class="line">命令(输入 m 获取帮助)： p</span><br><span class="line">Disk /dev/sdc：14.9 GiB，16005464064 字节，31260672 个扇区</span><br><span class="line">单元：扇区 / 1 * 512 = 512 字节</span><br><span class="line">扇区大小(逻辑/物理)：512 字节 / 512 字节</span><br><span class="line">I/O 大小(最小/最佳)：512 字节 / 512 字节</span><br><span class="line">磁盘标签类型：dos</span><br><span class="line">磁盘标识符：0x7f900099</span><br><span class="line"> </span><br><span class="line">命令(输入 m 获取帮助)： n</span><br><span class="line">分区类型</span><br><span class="line">   p   主分区 (0个主分区，0个扩展分区，4空闲)</span><br><span class="line">   e   扩展分区 (逻辑分区容器)</span><br><span class="line">选择 (默认 p)： p</span><br><span class="line">分区号 (1-4, 默认  1): 1</span><br><span class="line">第一个扇区 (2048-31260671, 默认 2048): 2048</span><br><span class="line">上个扇区，+sectors 或 +size&#123;K,M,G,T,P&#125; (2048-31260671, 默认 31260671): +256M</span><br><span class="line"> </span><br><span class="line">创建了一个新分区 1，类型为“Linux”，大小为 256 MiB。</span><br><span class="line"> </span><br><span class="line">命令(输入 m 获取帮助)： t</span><br><span class="line">已选择分区 1</span><br><span class="line">Hex 代码(输入 L 列出所有代码)： c</span><br><span class="line">已将分区“Linux”的类型更改为“W95 FAT32 (LBA)”。</span><br><span class="line"> </span><br><span class="line">命令(输入 m 获取帮助)： n</span><br><span class="line">分区类型</span><br><span class="line">   p   主分区 (1个主分区，0个扩展分区，3空闲)</span><br><span class="line">   e   扩展分区 (逻辑分区容器)</span><br><span class="line">选择 (默认 p)： p</span><br><span class="line">分区号 (2-4, 默认  2): 2</span><br><span class="line">第一个扇区 (526336-31260671, 默认 526336): 526336</span><br><span class="line">上个扇区，+sectors 或 +size&#123;K,M,G,T,P&#125; (526336-31260671, 默认 31260671): 31116287</span><br><span class="line"> </span><br><span class="line">创建了一个新分区 2，类型为“Linux”，大小为 14.6 GiB。</span><br><span class="line"> </span><br><span class="line">命令(输入 m 获取帮助)： w</span><br><span class="line">分区表已调整。</span><br><span class="line"> </span><br><span class="line">The kernel still uses the old partitions. The new table will be used at the next reboot.</span><br><span class="line">正在同步磁盘。</span><br></pre></td></tr></table></figure>

<p>给引导分区创建FAT32文件系统：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkfs.vfat -F 32 -n BOOT /dev/sdc1</span><br><span class="line">mkfs.fat 4.1 (2017-01-24)</span><br></pre></td></tr></table></figure>

<p>给根分区创建ext4文件系统：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkfs.ext4 /dev/sdc2</span><br><span class="line">mke2fs 1.44.4 (18-Aug-2018)</span><br><span class="line">创建含有 3823744 个块（每块 4k）和 956592 个inode的文件系统</span><br><span class="line">文件系统UUID：a02929a4-bc1b-4591-999b-7d4812b95edc</span><br><span class="line">超级块的备份存储于下列块：</span><br><span class="line">        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208</span><br><span class="line"> </span><br><span class="line">正在分配组表： 完成</span><br><span class="line">正在写入inode表： 完成</span><br><span class="line">创建日志（16384 个块） 完成</span><br><span class="line">写入超级块和文件系统账户统计信息：已完成</span><br></pre></td></tr></table></figure>

<p>挂载引导分区并复制文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir /mnt/tmp</span><br><span class="line">$ sudo mount /dev/sdc1 /mnt/tmp</span><br><span class="line">$ sudo cp ~/buildroot-2021.02/output/images/boot.bin /mnt/tmp</span><br><span class="line">$ sudo cp ~/buildroot-2021.02/output/images/u-boot.img /mnt/tmp</span><br><span class="line">$ sudo cp ~/buildroot-2021.02/output/images/uImage /mnt/tmp</span><br><span class="line">$ sudo cp ~/zc_pcie_dma/uEnv.txt /mnt/tmp</span><br><span class="line">$ sudo cp ~/zc_pcie_dma/devicetree.dtb /mnt/tmp</span><br><span class="line">$ sudo cp ~/zc_pcie_dma/zc_pcie_dma.bit /mnt/tmp</span><br><span class="line">$ sudo umount /mnt/tmp</span><br></pre></td></tr></table></figure>

<p>挂载根分区，复制根文件系统和内核模块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mount /dev/sdc2 /mnt/tmp</span><br><span class="line">$ sudo cp -a ~/debootstrap_focal_armhf/. /mnt/tmp</span><br><span class="line">$ sudo cp -a ~/buildroot-2021.02/output/target/lib/modules /mnt/tmp/lib</span><br><span class="line">$ sudo umount /mnt/tmp</span><br></pre></td></tr></table></figure>

<p>弹出SD卡：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo eject /dev/sdc</span><br></pre></td></tr></table></figure>

<p>sd卡插回zc706，连接USB串口调试线，SW11设置为00110（SD卡引导模式），插上网线。</p>
<p>主机开始监听</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo miniterm.py --eol LF --raw /dev/ttyUSB0 115200</span><br></pre></td></tr></table></figure>

<p>自动加载内核失败，进入u-boot命令行，手动加载内核：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zynq&gt; run load_image</span><br><span class="line">zynq&gt; bootm $&#123;kernel_load_address&#125; - $&#123;devicetree_load_address&#125;</span><br></pre></td></tr></table></figure>

<p>成功加载ubuntu 20.04:</p>
<p><img src="https://i.loli.net/2021/07/27/LjChPQNvkRldapK.png" alt="image-20210727174608785"></p>
<h1 id="zc706-ubuntu环境配置"><a href="#zc706-ubuntu环境配置" class="headerlink" title="zc706 ubuntu环境配置"></a>zc706 ubuntu环境配置</h1><p>配置网络：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ifconfig eth0 up</span><br><span class="line">$ sudo dhclient eth0</span><br><span class="line">$ sudo service network-manager restart</span><br></pre></td></tr></table></figure>

<p>安装python2.7和相关依赖库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install software-properties-common</span><br><span class="line">$ sudo add-apt-repository universe</span><br><span class="line">$ sudo apt install python2</span><br><span class="line">$ sudo apt install python-dev python-setuptools libssl-dev</span><br></pre></td></tr></table></figure>

<p>安装pip：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install curl</span><br><span class="line">$ curl https://bootstrap.pypa.io/pip/2.7/get-pip.py --output get-pip.py</span><br><span class="line">$ sudo python2 get-pip.py</span><br></pre></td></tr></table></figure>

<p>安装gcc：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install gcc-9 gcc-9-multilib</span><br></pre></td></tr></table></figure>

<p>安装numpy包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pip install numpy</span><br></pre></td></tr></table></figure>

<p>获取s6_pcie_microblaze项目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/Cr4sh/s6_pcie_microblaze.git</span><br></pre></td></tr></table></figure>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/project/2023/08/08/PCIe-TLP%E6%95%B0%E6%8D%AE%E5%8C%85%E5%8E%9F%E7%90%86/"
      title="PCIe TLP数据包原理"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        PCIe TLP数据包原理
        
    </p>
  </a>
  <a class="article-nav-btn right  disabled "
     >

    <p class="title-text">
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>


  
  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <div id="comment-card" class="comment-card">
    <div class="main-title-bar">
      <div class="main-title-dot"></div>
      <div class="main-title">留言 </div>
    </div>
    <div id="vcomments"></div>
  </div>
  <script>
      new Valine({"enable":true,"appId":"bC8HOSKa4QB7G6TfuGWB97i4-gzGzoHsz","appKey":"aoDFuSX5vWN8Xn1ukZpJ50be","placeholder":"写下你的评论...","pageSize":10,"highlight":true,"serverURLs":null,"el":"#vcomments"});
  </script>
 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2023 Edvison<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn" onclick="topFunction()">
        <span class="material-symbols-rounded">keyboard_arrow_up</span>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.style.opacity = 1;
        } else {
            btn.style.opacity = 0;
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/project/js/light-dark-switch.js"></script>
</body>
</html>
